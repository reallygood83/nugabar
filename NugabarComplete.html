<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ + ëˆ„ê°€ê¸°ë¡ ìƒì„±ê¸° - Complete System</title>
  <style>
    :root {
      --primary-blue: #1976D2;
      --secondary-green: #2E7D32;
      --accent-orange: #F57F17;
      --accent-teal: #00695C;
      --text-primary: #212121;
      --text-secondary: #757575;
      --background: #FAFAFA;
      --surface: #FFFFFF;
      --error: #D32F2F;
      --warning: #F57C00;
      --success: #388E3C;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: var(--space-md);
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #e0e0e0;
    }

    .header h1 {
      font-size: 2.8rem;
      color: #4285F4;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .complete-badge {
      background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 700;
      margin-left: 0.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .header p {
      color: #666;
      font-size: 1.2rem;
      font-weight: 500;
    }

    .workspace-info {
      background: #ffffff;
      border: 2px solid #34A853;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(52, 168, 83, 0.1);
    }

    .workspace-info h3 {
      color: #34A853;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .workspace-info p {
      color: #333;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }

    .workspace-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* AI ìƒì„± í…ìŠ¤íŠ¸ ì‹œê°ì  êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
    .generation-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .ai-badge {
      background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
      color: white;
      animation: pulse 2s infinite;
    }

    .basic-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .ai-generated {
      background: linear-gradient(135deg, #fff5f5 0%, #f0fdfd 100%);
      border: 2px solid #FF6B6B;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);
    }

    .basic-generated {
      background: linear-gradient(135deg, #f8f9ff 0%, #f3f4f6 100%);
      border: 2px solid #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    /* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .copy-button-overlay {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .copy-button-overlay:hover {
      background: #4285F4;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .copy-button-small {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: 0.5rem;
    }

    .copy-button-small:hover {
      background: #4285F4;
      color: white;
      border-color: #4285F4;
    }

    .textarea-container {
      position: relative;
      margin-bottom: 1rem;
    }

    /* ëˆ„ê°€ê¸°ë¡ í‘œì‹œ í–¥ìƒ */
    .record-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
      padding: 0.8rem 1rem;
      border-radius: 8px 8px 0 0;
      border-bottom: 2px solid #34A853;
    }

    .record-content {
      background: white;
      padding: 1rem;
      border-radius: 0 0 8px 8px;
      border: 2px solid #34A853;
      border-top: none;
      line-height: 1.6;
      font-size: 0.95rem;
    }

    .record-meta {
      display: flex;
      gap: 1rem;
      align-items: center;
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid #eee;
    }

    .compliance-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-align: center;
    }

    .compliance-badge.compliant {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .compliance-badge.warning {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    /* íƒ­ ì‹œìŠ¤í…œ */
    .tab-container {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 3px solid #e0e0e0;
      overflow-x: auto;
    }

    .tab-button {
      padding: 1.2rem 2rem;
      border: none;
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 12px 12px 0 0;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
      position: relative;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .tab-button:hover {
      background: #f0f7ff;
      color: var(--primary-blue);
      transform: translateY(-2px);
      border-color: #e3f2fd;
      box-shadow: 0 4px 16px rgba(25, 118, 210, 0.15);
    }

    .tab-button.active {
      background: var(--primary-blue);
      color: white;
      border-bottom: 3px solid var(--primary-blue);
      border-color: var(--primary-blue);
      box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
      transform: translateY(-2px);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-size: 1.6rem;
      color: #333;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 0.8rem;
      font-weight: 600;
    }

    /* í‚¤ì›Œë“œ ê²€ìƒ‰ ë° í†µê³„ */
    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 2;
      position: relative;
      min-width: 300px;
    }

    .search-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 1.1rem;
      background: white;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 1.2rem;
    }

    .statistics {
      flex: 1;
      display: flex;
      gap: 1rem;
      min-width: 300px;
    }

    .stat-card {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      flex: 1;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.2rem;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* ì„ íƒëœ í‚¤ì›Œë“œ í‘œì‹œ */
    .selected-keywords {
      background: #f8f9fa;
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      min-height: 80px;
    }

    .selected-keywords h4 {
      color: #666;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .keyword-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .keyword-badge {
      background: #4285F4;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      animation: slideIn 0.3s ease;
    }

    .keyword-badge .intensity {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      font-size: 0.8rem;
    }

    .keyword-badge .remove {
      cursor: pointer;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: background 0.2s ease;
    }

    .keyword-badge .remove:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ì¹´í…Œê³ ë¦¬ í•„í„° */
    .category-filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .category-filter {
      padding: 0.8rem 1.5rem;
      border: 2px solid #e0e0e0;
      background: white;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .category-filter:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .category-filter.active {
      background: #4285F4;
      color: white;
      border-color: #4285F4;
    }

    /* í‚¤ì›Œë“œ ê·¸ë¦¬ë“œ */
    .keyword-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .keyword-category {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .keyword-category:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .category-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-title {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .category-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.9rem;
    }

    .keyword-list {
      padding: 1.5rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .keyword-list.collapsed {
      display: none;
    }

    .keyword-item {
      display: flex;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #eee;
      transition: background 0.2s ease;
    }

    .keyword-item:hover {
      background: #f0f0f0;
      border-radius: 8px;
      padding-left: 0.5rem;
    }

    .keyword-item:last-child {
      border-bottom: none;
    }

    .keyword-checkbox {
      margin-right: 1rem;
      transform: scale(1.2);
      cursor: pointer;
    }

    .keyword-label {
      flex: 1;
      cursor: pointer;
      font-weight: 500;
      font-size: 1rem;
    }

    .keyword-intensity {
      display: flex;
      gap: 0.25rem;
    }

    .intensity-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 15px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .intensity-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .intensity-btn.active {
      background: #4285F4;
      color: white;
      border-color: #4285F4;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-right: 1rem;
      margin-bottom: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #4285F4 0%, #1976D2 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #34A853 0%, #2E7D32 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #FBBC04 0%, #F57F17 100%);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    /* ì…ë ¥ í•„ë“œ */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      color: #333;
      font-size: 1.1rem;
    }

    .form-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      font-family: inherit;
    }

    /* í•™ìƒ ì •ë³´ ì…ë ¥ í¼ */
    .student-form-container {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
      border: 2px solid #4285F4;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      align-items: end;
    }

    .student-info-display {
      margin-top: 1rem;
      padding: 1rem;
      background: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .info-badge {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .student-number-badge, .student-name-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      border: 2px solid;
    }

    .student-number-badge {
      background: #ffffff;
      color: #1976D2;
      border-color: #1976D2;
    }

    .student-name-badge {
      background: #ffffff;
      color: #34A853;
      border-color: #34A853;
    }

    /* ì €ì¥ëœ í•™ìƒ ëª©ë¡ */
    .saved-students-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .student-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      margin: 0.5rem 0;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .student-item:hover {
      background: #f0f8ff;
      border-color: #4285F4;
    }

    .student-info {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .student-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-small {
      padding: 0.3rem 0.8rem;
      font-size: 0.85rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-edit {
      background: #FFC107;
      color: #212529;
    }

    .btn-delete {
      background: #DC3545;
      color: white;
    }

    /* ëˆ„ê°€ê¸°ë¡ ìƒì„± ì˜µì…˜ */
    .generation-options {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.8rem 1rem;
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .radio-option:hover {
      background: #e3f2fd;
      border-color: #4285F4;
    }

    .radio-option input[type="radio"]:checked + span {
      font-weight: 600;
      color: #4285F4;
    }

    .radio-option input[type="radio"] {
      margin: 0;
    }

    .button-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .button-group .btn {
      flex: 1;
    }

    /* ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡ í‘œì‹œ */
    .record-group {
      margin-bottom: 1.2rem;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }

    .record-group h4 {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
      margin: 0;
      padding: 1rem;
      font-size: 1.1rem;
    }

    .records-container {
      padding: 1rem;
    }

    .record-item {
      margin-bottom: 1rem;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
    }

    .record-header {
      background: #f8f9fa;
      padding: 0.8rem;
      font-weight: 600;
      color: #495057;
      border-bottom: 1px solid #e9ecef;
    }

    .record-content {
      padding: 1rem;
      line-height: 1.6;
      color: #333;
      white-space: normal;
    }

    /* ë¯¸ë¦¬ë³´ê¸° */
    .preview-box {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border: 2px solid #e0e0e0;
      border-radius: 15px;
      padding: 2rem;
      margin-top: 1.5rem;
      min-height: 150px;
      white-space: normal;
      line-height: 1.8;
      font-size: 1.1rem;
      position: relative;
    }

    .preview-box.has-content {
      background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
      border-color: #34A853;
    }

    .copy-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .copy-button:hover {
      background: #1976D2;
      transform: scale(1.05);
    }

    /* ì•Œë¦¼ */
    .alert {
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border-left: 5px solid;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .alert-info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .alert-warning {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    /* NEIS ê·œì • í‘œì‹œ */
    .compliance-status {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .compliance-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .compliance-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .compliance-icon.pass {
      background: #28a745;
    }

    .compliance-icon.fail {
      background: #dc3545;
    }

    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #ddd;
      border-radius: 50%;
      border-top-color: #4285F4;
      animation: spin 1s linear infinite;
      margin-left: 1rem;
    }

    /* í–¥ìƒëœ ë¡œë”© ìƒíƒœ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      font-size: 1.2rem;
      color: #333;
    }

    .loading-spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4285F4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 1rem;
    }

    .loading-progress {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 1.5rem;
      margin: 1rem 0;
      text-align: center;
      font-size: 1.1rem;
      color: #495057;
    }

    .loading-progress .progress-bar {
      background: #e9ecef;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .loading-progress .progress-fill {
      background: linear-gradient(90deg, #4285F4, #34A853);
      height: 100%;
      border-radius: 4px;
      animation: loading-progress 2s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes loading-progress {
      0% { width: 0%; }
      50% { width: 100%; }
      100% { width: 0%; }
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .keyword-grid {
        grid-template-columns: 1fr;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .statistics {
        min-width: 100%;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
        margin-right: 0;
      }
    }

    .hidden {
      display: none !important;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    .fade-in {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* AI ì„¤ì • ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .ai-info {
      margin-bottom: 2rem;
    }

    .info-card {
      background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
      border: 2px solid #4285F4;
      border-radius: 15px;
      padding: 1.5rem;
    }

    .info-card h4 {
      color: #4285F4;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .info-card ul {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .info-card li {
      margin: 0.5rem 0;
      color: #666;
    }

    .api-key-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .api-key-container .form-input {
      flex: 1;
    }

    .form-help {
      margin-top: 0.5rem;
    }

    .form-help small {
      color: #666;
      font-size: 0.9rem;
    }

    .form-help a {
      color: #4285F4;
      text-decoration: none;
    }

    .form-help a:hover {
      text-decoration: underline;
    }

    .api-key-actions {
      display: flex;
      gap: 1rem;
      margin: 1.5rem 0;
      flex-wrap: wrap;
    }

    .api-status {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #6c757d;
    }

    .status-indicator.connected .status-dot {
      background: #28a745;
      animation: pulse 2s infinite;
    }

    .status-indicator.error .status-dot {
      background: #dc3545;
    }

    .status-indicator.testing .status-dot {
      background: #ffc107;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .usage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .usage-card {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
    }

    .usage-number {
      font-size: 2rem;
      font-weight: 700;
      color: #856404;
      margin-bottom: 0.5rem;
    }

    .usage-label {
      color: #856404;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .usage-tips {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 15px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .usage-tips h4 {
      color: #155724;
      margin-bottom: 1rem;
    }

    .usage-tips ul {
      margin: 0;
      padding-left: 1.5rem;
    }

    .usage-tips li {
      margin: 0.5rem 0;
      color: #155724;
    }

    .required {
      color: #dc3545;
      margin-left: 0.25rem;
    }

    /* ë°˜ì‘í˜• AI ì„¤ì • */
    @media (max-width: 768px) {
      .api-key-actions {
        flex-direction: column;
      }
      
      .usage-stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        ğŸ“Š í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ + ëˆ„ê°€ê¸°ë¡ ìƒì„±ê¸°
        <span class="complete-badge">Complete System</span>
      </h1>
      <p>í‚¤ì›Œë“œ ì¤‘ì‹¬ì˜ í•™ìƒ ê´€ì°° ê¸°ë¡ ì‹œìŠ¤í…œ</p>
      <div style="margin-top: 1rem; padding: 0.8rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <p style="font-size: 1rem; margin: 0; font-weight: 500;">
          ğŸ“ ê°œë°œì: <strong>ê¹€ë¬¸ì •(ë°•ë‹¬ì´ˆ)</strong> | 
          ğŸ“º ìœ íŠœë¸Œ: <a href="https://www.youtube.com/@%EB%B0%B0%EC%9B%80%EC%9D%98%EB%8B%AC%EC%9D%B8-p5v" target="_blank" style="color: #FFE082; text-decoration: none; font-weight: 600; border-bottom: 1px solid #FFE082;">ë°°ì›€ì˜ë‹¬ì¸</a>
        </p>
      </div>
    </div>

    <div class="workspace-info">
      <h3>ğŸ”— Google Sheets ì›Œí¬ìŠ¤í˜ì´ìŠ¤</h3>
      <p>ëª¨ë“  ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ Google Sheetsì— ì €ì¥ë©ë‹ˆë‹¤.</p>
      <div class="workspace-actions">
        <button class="btn btn-primary" onclick="createWorkspace()">
          âœ¨ ìƒˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„±
        </button>
        <button class="btn btn-secondary" onclick="openSampleWorkspace()">
          ğŸ“‹ ìƒ˜í”Œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë³´ê¸°
        </button>
      </div>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="tab-container">
      <button class="tab-button active" onclick="showTab('settings')">
        âš™ï¸ AI ì„¤ì •
      </button>
      <button class="tab-button" onclick="showTab('behavior')">
        ğŸ¯ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬
      </button>
      <button class="tab-button" onclick="showTab('records')">
        ğŸ“‹ ëˆ„ê°€ê¸°ë¡ ìƒì„±
      </button>
      <button class="tab-button" onclick="showTab('management')">
        ğŸ‘¥ í•™ìƒ ê´€ë¦¬
      </button>
    </div>

    <!-- í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ íƒ­ -->
    <div id="behavior-tab" class="tab-content">
      <!-- í•™ìƒ ì •ë³´ ì…ë ¥ ì„¹ì…˜ -->
      <div class="section">
        <div class="section-title">
          ğŸ‘¨â€ğŸ“ í•™ìƒ ì •ë³´ ì…ë ¥
        </div>
        
        <div class="student-form-container">
          <div class="form-row">
            <div class="form-group" style="flex: 1; margin-right: 1rem;">
              <label class="form-label" for="studentNumber">í•™ìƒ ë²ˆí˜¸</label>
              <input type="number" id="studentNumber" class="form-input" placeholder="ì˜ˆ: 1" min="1" max="50">
            </div>
            <div class="form-group" style="flex: 2;">
              <label class="form-label" for="studentName">í•™ìƒ ì´ë¦„</label>
              <input type="text" id="studentName" class="form-input" placeholder="ì˜ˆ: í™ê¸¸ë™">
            </div>
          </div>
          
          <div class="student-info-display" id="studentInfoDisplay" style="display: none;">
            <div class="info-badge">
              <span class="student-number-badge"></span>
              <span class="student-name-badge"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰ ë° ì„ íƒ
        </div>

        <div class="search-container">
          <div class="search-box">
            <div class="search-icon">ğŸ”</div>
            <input type="text" class="search-input" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰..." id="keywordSearch">
          </div>
          <div class="statistics">
            <div class="stat-card">
              <div class="stat-number" id="selectedCount">0</div>
              <div class="stat-label">ì„ íƒë¨</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="visibleCount">63</div>
              <div class="stat-label">í‘œì‹œë¨</div>
            </div>
          </div>
        </div>

        <div class="selected-keywords">
          <h4>ì„ íƒëœ í‚¤ì›Œë“œ</h4>
          <div class="keyword-badges" id="selectedKeywords">
            <span style="color: #999;">í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>
          </div>
        </div>

        <div class="category-filters">
          <button class="category-filter active" onclick="filterCategory('all')">ì „ì²´ (63)</button>
          <button class="category-filter" onclick="filterCategory('learning_attitude')">í•™ìŠµíƒœë„ (10)</button>
          <button class="category-filter" onclick="filterCategory('social_skills')">ëŒ€ì¸ê´€ê³„ (10)</button>
          <button class="category-filter" onclick="filterCategory('cognitive_abilities')">í•™ìŠµëŠ¥ë ¥ (10)</button>
          <button class="category-filter" onclick="filterCategory('participation_level')">ì°¸ì—¬ë„ (10)</button>
          <button class="category-filter" onclick="filterCategory('character_traits')">ì„±ê²©íŠ¹ì„± (10)</button>
          <button class="category-filter" onclick="filterCategory('special_talents')">íŠ¹ê¸°ì‚¬í•­ (10)</button>
        </div>

        <div class="keyword-grid" id="keywordGrid">
          <div class="loading">í‚¤ì›Œë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          âœï¸ ë§ì¶¤í˜• ì…ë ¥
        </div>
        
        <div class="form-group">
          <label class="form-label">ê´€ì°° ìƒí™©</label>
          <input type="text" class="form-input" id="observationContext" placeholder="ì˜ˆ: ìˆ˜ì—… ì‹œê°„, ëª¨ë‘  í™œë™, ë°œí‘œ ì‹œê°„ ë“±">
        </div>

        <div class="form-group">
          <label class="form-label">í•™ê¸‰ í™œë™</label>
          <input type="text" class="form-input" id="classActivity" placeholder="ì˜ˆ: í† ë¡  í™œë™, í”„ë¡œì íŠ¸ ìˆ˜í–‰, ì²´í—˜ í™œë™ ë“±">
        </div>

        <div class="form-group">
          <label class="form-label">íŠ¹ë³„ í”„ë¡œê·¸ë¨</label>
          <input type="text" class="form-input" id="specialProgram" placeholder="ì˜ˆ: ë…ì„œ í™œë™, ë´‰ì‚¬ í™œë™, ì°½ì²´ í™œë™ ë“±">
        </div>

        <button class="btn btn-primary" id="generateBtn" onclick="generateBehaviorText()">
          âœ¨ í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ìƒì„±
        </button>
        <button class="btn btn-success" onclick="saveBehaviorText()">
          ğŸ’¾ Google Sheets ì €ì¥
        </button>
        <button class="btn btn-warning" onclick="clearSelection()">
          ğŸ—‘ï¸ ì„ íƒ ì´ˆê¸°í™”
        </button>
      </div>

      <div class="section">
        <div class="section-title">
          âœï¸ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ (AI ìƒì„± ë° ìˆ˜ë™ í¸ì§‘)
        </div>
        <div class="textarea-container" style="position: relative;">
          <textarea class="form-input form-textarea preview-box" id="behaviorPreview" 
                    placeholder="í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ê³  'í–‰ë™íŠ¹ì„± ìƒì„±' ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜, ì—¬ê¸°ì— ì§ì ‘ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." 
                    style="min-height: 180px; resize: vertical; padding-right: 50px; line-height: 1.6;"
                    oninput="updatePreviewFromTextarea()">
          </textarea>
          <button class="copy-button-overlay" onclick="copyToClipboard('behaviorPreview')" title="ë‚´ìš© ë³µì‚¬" 
                  style="position: absolute; top: 10px; right: 10px; background: rgba(66, 133, 244, 0.9); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 14px; z-index: 10;">
            ğŸ“‹
          </button>
        </div>
        <div class="textarea-tools" style="margin-top: 0.5rem; display: flex; gap: 1rem; align-items: center; font-size: 0.85rem; color: #666;">
          <span id="charCountDisplay">0ì</span>
          <button class="btn-small" onclick="clearBehaviorText()" style="padding: 4px 8px; font-size: 0.8rem;">ğŸ—‘ï¸ ì§€ìš°ê¸°</button>
          <button class="btn-small" onclick="formatBehaviorText()" style="padding: 4px 8px; font-size: 0.8rem;">ğŸ“ ì •ë¦¬</button>
        </div>
        
        <div class="compliance-status hidden" id="complianceStatus">
          <h4 style="margin-bottom: 1rem;">ğŸ“‹ NEIS ê·œì • ì¤€ìˆ˜ ê²€ì‚¬</h4>
          <div class="compliance-item">
            <div class="compliance-icon" id="lengthIcon">ğŸ“</div>
            <span id="lengthCheck">ê¸€ì ìˆ˜: 0/500ì</span>
          </div>
          <div class="compliance-item">
            <div class="compliance-icon" id="endingIcon">âœï¸</div>
            <span id="endingCheck">ëª…ì‚¬í˜• ì¢…ê²° í™•ì¸</span>
          </div>
          <div class="compliance-item">
            <div class="compliance-icon" id="contentIcon">ğŸš«</div>
            <span id="contentCheck">ê¸ˆì§€ ë‚´ìš© í™•ì¸</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ëˆ„ê°€ê¸°ë¡ ìƒì„± íƒ­ -->
    <div id="records-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          ğŸ“‹ ëˆ„ê°€ê¸°ë¡ ìƒì„±
        </div>
        
        <div class="alert alert-info">
          <strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong> ë¨¼ì € "í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬" íƒ­ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•œ í›„, ì—¬ê¸°ì„œ ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•˜ì„¸ìš”.
        </div>

        <div class="form-group">
          <label class="form-label">ìƒì„±ëœ í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸</label>
          <div class="textarea-container">
            <textarea class="form-input form-textarea" id="behaviorTextInput" placeholder="í–‰ë™íŠ¹ì„± íƒ­ì—ì„œ ìƒì„±ëœ í…ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤." readonly></textarea>
            <button class="copy-button-overlay" onclick="copyToClipboard('behaviorTextInput')" title="í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ë³µì‚¬">
              ğŸ“‹
            </button>
          </div>
        </div>

        <!-- ì €ì¥ëœ í•™ìƒ ëª©ë¡ ê´€ë¦¬ -->
        <div class="form-group">
          <label class="form-label">ğŸ“š ì €ì¥ëœ í•™ìƒ ëª©ë¡</label>
          <div class="saved-students-container" id="savedStudentsContainer">
            <div id="noStudentsMessage" style="text-align: center; color: #666; padding: 2rem;">
              ì•„ì§ ì €ì¥ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.<br>
              í–‰ë™íŠ¹ì„± íƒ­ì—ì„œ í•™ìƒë³„ë¡œ í–‰ë™íŠ¹ì„±ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
            </div>
            <div id="studentsList" style="display: none;"></div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ëˆ„ê°€ê¸°ë¡ ìƒì„± ë°©ì‹</label>
          <div class="generation-options">
            <label class="radio-option">
              <input type="radio" name="generationType" value="all" checked>
              <span>ì „ì²´ í•™ìƒ ëˆ„ê°€ê¸°ë¡ ìƒì„±</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="generationType" value="selected">
              <span>ì„ íƒí•œ í•™ìƒë§Œ ìƒì„±</span>
            </label>
          </div>
        </div>

        <!-- ë‚ ì§œ ì„¤ì • -->
        <div class="form-group">
          <label class="form-label">ğŸ“… ëˆ„ê°€ê¸°ë¡ ë‚ ì§œ ì„¤ì •</label>
          <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; align-items: end;">
              <div>
                <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">ë…„ë„</label>
                <input type="number" class="form-input" id="recordYear" value="2025" min="2020" max="2030" style="padding: 0.7rem; font-size: 0.9rem;">
              </div>
              <div>
                <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">ì‹œì‘ì›”</label>
                <select class="form-input" id="recordStartMonth" style="padding: 0.7rem; font-size: 0.9rem;">
                  <option value="1">1ì›”</option>
                  <option value="2">2ì›”</option>
                  <option value="3" selected>3ì›”</option>
                  <option value="4">4ì›”</option>
                  <option value="5">5ì›”</option>
                  <option value="6">6ì›”</option>
                  <option value="7">7ì›”</option>
                  <option value="8">8ì›”</option>
                  <option value="9">9ì›”</option>
                  <option value="10">10ì›”</option>
                  <option value="11">11ì›”</option>
                  <option value="12">12ì›”</option>
                </select>
              </div>
              <div>
                <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">ì¢…ë£Œì›”</label>
                <select class="form-input" id="recordEndMonth" style="padding: 0.7rem; font-size: 0.9rem;">
                  <option value="1">1ì›”</option>
                  <option value="2">2ì›”</option>
                  <option value="3">3ì›”</option>
                  <option value="4">4ì›”</option>
                  <option value="5">5ì›”</option>
                  <option value="6">6ì›”</option>
                  <option value="7" selected>7ì›”</option>
                  <option value="8">8ì›”</option>
                  <option value="9">9ì›”</option>
                  <option value="10">10ì›”</option>
                  <option value="11">11ì›”</option>
                  <option value="12">12ì›”</option>
                </select>
              </div>
              <div>
                <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">ìƒì„± ê°œìˆ˜</label>
                <input type="number" class="form-input" id="recordCount" value="5" min="1" max="20" style="padding: 0.7rem; font-size: 0.9rem;">
              </div>
            </div>
            <div style="margin-top: 1rem; padding: 0.8rem; background: #e3f2fd; border-radius: 8px; font-size: 0.85rem; color: #1976d2;">
              ğŸ“ <strong>ì•ˆë‚´:</strong> ì„¤ì •í•œ ê¸°ê°„ì˜ í‰ì¼(ì›”~ê¸ˆ) ì¤‘ ê³µíœ´ì¼ì„ ì œì™¸í•œ ë‚ ì§œì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn btn-primary" onclick="generateStudentRecords()">
            ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„±
          </button>
          <button class="btn btn-info" onclick="refreshStudentsList()">
            ğŸ”„ í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        <button class="btn btn-success" onclick="saveRecords()">
          ğŸ’¾ Google Sheets ì €ì¥
        </button>
        <button class="btn btn-warning" onclick="exportRecords()">
          ğŸ“¤ Excel ë‚´ë³´ë‚´ê¸°
        </button>
      </div>

      <div class="section">
        <div class="section-title">
          ğŸ“‹ ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡
          <button class="btn btn-secondary btn-sm" id="copyAllRecordsBtn" onclick="copyAllRecords()" style="display: none; margin-left: 1rem;">
            ğŸ“‹ ì „ì²´ ë³µì‚¬
          </button>
        </div>
        <div id="recordsList">
          <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 12px; margin: 1rem 0;">
            <p style="color: #666; margin-bottom: 1rem; font-size: 1rem;">ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            
            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
              <h4 style="color: #856404; margin: 0 0 0.5rem 0; font-size: 1rem;">âš ï¸ ë‹¤ì¤‘ í•™ìƒ ìƒì„± ì‹œ ì°¸ê³ ì‚¬í•­</h4>
              <p style="color: #856404; margin: 0; font-size: 0.9rem; line-height: 1.4;">
                ì—¬ëŸ¬ í•™ìƒì„ í•œ ë²ˆì— ìƒì„±í•  ë•Œ Rate Limitingìœ¼ë¡œ ì¸í•´ ì¼ë¶€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                <strong>ê¶Œì¥:</strong> 1-2ëª…ì”© ë‚˜ëˆ„ì–´ ìƒì„±í•˜ê±°ë‚˜, ì‹¤íŒ¨ ì‹œ ê°œë³„ í•™ìƒìœ¼ë¡œ ì¬ì‹œë„í•´ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•™ìƒ ê´€ë¦¬ íƒ­ -->
    <div id="management-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          ğŸ‘¥ í•™ìƒ ì •ë³´ ê´€ë¦¬
        </div>
        
        <div class="form-group">
          <label class="form-label">í•™ìƒ ì´ë¦„</label>
          <input type="text" class="form-input" id="recordsStudentName" placeholder="í•™ìƒ ì´ë¦„ ì…ë ¥">
        </div>

        <div class="form-group">
          <label class="form-label">í•™ê¸‰</label>
          <input type="text" class="form-input" id="studentClass" placeholder="ì˜ˆ: 3í•™ë…„ 1ë°˜">
        </div>

        <div class="form-group">
          <label class="form-label">í•™ìƒ ë²ˆí˜¸</label>
          <input type="text" class="form-input" id="recordsStudentNumber" placeholder="ì˜ˆ: 1, 2, 3...">
        </div>

        <button class="btn btn-primary" onclick="addStudent()">
          â• í•™ìƒ ì¶”ê°€
        </button>
        <button class="btn btn-success" onclick="saveStudentData()">
          ğŸ’¾ í•™ìƒ ì •ë³´ ì €ì¥
        </button>
      </div>

      <div class="section">
        <div class="section-title">
          ğŸ“Š ì‚¬ìš© í†µê³„
        </div>
        <div id="usageStats">
          <div class="loading">í†µê³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- AI ì„¤ì • íƒ­ -->
    <div id="settings-tab" class="tab-content active">
      <div class="section">
        <div class="section-title">
          ğŸ¤– GEMINI AI ì„¤ì •
        </div>
        
        <div class="ai-info">
          <div style="background: linear-gradient(135deg, #fff5f5 0%, #fff3cd 100%); border: 2px solid #fd7e14; border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
            <h3 style="color: #fd7e14; margin-bottom: 1rem;">âš ï¸ í•„ìˆ˜ ì„¤ì • ì•ˆë‚´</h3>
            <p style="font-size: 1.1rem; font-weight: 600; color: #495057; margin-bottom: 0.5rem;">
              AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <strong>ë³¸ì¸ì˜ GEMINI API í‚¤</strong>ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.
            </p>
            <p style="color: #6c757d; font-size: 0.95rem;">
              API í‚¤ ì—†ì´ëŠ” ê¸°ë³¸ ìƒì„±ë§Œ ê°€ëŠ¥í•˜ë©°, AI ì „ë¬¸ ìƒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
          </div>
          
          <div class="info-card">
            <h4>ğŸš€ AI ê¸°ëŠ¥ ì•ˆë‚´</h4>
            <p>GEMINI APIë¥¼ í™œìš©í•˜ì—¬ ë”ìš± ìì—°ìŠ¤ëŸ½ê³  ì „ë¬¸ì ì¸ í–‰ë™íŠ¹ì„± ë° ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <ul>
              <li>âœ¨ í‚¤ì›Œë“œ ê¸°ë°˜ ìì—°ì–´ ìƒì„±</li>
              <li>ğŸ“ NEIS ê·œì • ìë™ ì¤€ìˆ˜</li>
              <li>ğŸ¯ ë§¥ë½ ê¸°ë°˜ ê°œì¸í™”</li>
              <li>ğŸ”„ ì•ˆì „í•œ í´ë°± ì‹œìŠ¤í…œ</li>
            </ul>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            ğŸ”‘ GEMINI API í‚¤ (í•„ìˆ˜)
            <span class="required">*</span>
          </label>
          <div class="api-key-container">
            <input type="password" class="form-input" id="geminiApiKey" 
                   placeholder="Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()" id="toggleApiKey">
              ğŸ‘ï¸ ë³´ê¸°
            </button>
          </div>
          <div class="form-help">
            <small>
              ğŸ’¡ API í‚¤ ë°œê¸‰: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
              | ë¬´ë£Œ í• ë‹¹ëŸ‰: ì›” 15íšŒ ìš”ì²­
            </small>
          </div>
        </div>

        <div class="api-key-actions">
          <button class="btn btn-primary" onclick="testApiKey()">
            ğŸ§ª API í‚¤ í…ŒìŠ¤íŠ¸
          </button>
          <button class="btn btn-success" onclick="saveApiKey()">
            ğŸ’¾ API í‚¤ ì €ì¥
          </button>
          <button class="btn btn-warning" onclick="clearApiKey()">
            ğŸ—‘ï¸ API í‚¤ ì œê±°
          </button>
        </div>

        <div id="apiStatus" class="api-status">
          <div class="status-indicator" id="statusIndicator">
            <span class="status-dot"></span>
            <span id="statusText">API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          âš™ï¸ AI ìƒì„± ì˜µì…˜
        </div>

        <div class="form-group">
          <label class="form-label">í–‰ë™íŠ¹ì„± ìƒì„± ìŠ¤íƒ€ì¼</label>
          <select class="form-input" id="behaviorStyle">
            <option value="standard">í‘œì¤€í˜• (êµìœ¡ì  ë§¥ë½ ì¤‘ì‹¬)</option>
            <option value="detailed">ìƒì„¸í˜• (êµ¬ì²´ì  í–‰ë™ ë¬˜ì‚¬)</option>
            <option value="simple">ê°„ê²°í˜• (í•µì‹¬ ë‚´ìš© ìœ„ì£¼)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">ëˆ„ê°€ê¸°ë¡ ìƒì„± ê°œìˆ˜</label>
          <select class="form-input" id="recordCount">
            <option value="3">3ê°œ</option>
            <option value="5" selected>5ê°œ</option>
            <option value="7">7ê°œ</option>
            <option value="10">10ê°œ</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="includeActivities" checked> 
            ë‹¤ì–‘í•œ í™œë™ ìƒí™© í¬í•¨
          </label>
        </div>

        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="useAiFallback" checked> 
            AI ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë°©ì‹ ì‚¬ìš©
          </label>
        </div>
      </div>

      <div class="section">
        <div class="section-title">
          ğŸ“Š ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
        </div>
        
        <div class="usage-stats">
          <div class="usage-card">
            <div class="usage-number" id="todayUsage">0</div>
            <div class="usage-label">ì˜¤ëŠ˜ ì‚¬ìš©</div>
          </div>
          <div class="usage-card">
            <div class="usage-number" id="monthUsage">0</div>
            <div class="usage-label">ì´ë²ˆ ë‹¬ ì‚¬ìš©</div>
          </div>
          <div class="usage-card">
            <div class="usage-number" id="totalUsage">0</div>
            <div class="usage-label">ì´ ì‚¬ìš©ëŸ‰</div>
          </div>
        </div>

        <div class="usage-tips">
          <h4>ğŸ’¡ ì‚¬ìš©ëŸ‰ ì ˆì•½ íŒ</h4>
          <ul>
            <li>ğŸ¯ í‚¤ì›Œë“œ ì„ íƒì„ ì‹ ì¤‘í•˜ê²Œ í•˜ì—¬ ì¬ìƒì„± íšŸìˆ˜ ì¤„ì´ê¸°</li>
            <li>ğŸ“ ë§¥ë½ ì •ë³´ë¥¼ ìƒì„¸íˆ ì…ë ¥í•˜ì—¬ ì²« ë²ˆì§¸ ìƒì„±ì—ì„œ ë§Œì¡±í•  ë§Œí•œ ê²°ê³¼ ì–»ê¸°</li>
            <li>ğŸ”„ í´ë°± ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ AI í˜¸ì¶œ íšŸìˆ˜ ìµœì†Œí™”</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let keywordDatabase = [];
    let selectedKeywords = [];
    let currentCategory = 'all';
    let behaviorText = '';
    let generatedRecords = [];
    let currentSpreadsheetId = '';
    
    // AI ì„¤ì • ê´€ë ¨ ë³€ìˆ˜
    let geminiApiKey = '';
    let currentCharCount = 500;
    let currentContentStyle = 'generic';
    let aiSettings = {
      behaviorStyle: 'standard',
      recordCount: 5,
      includeActivities: true,
      useAiFallback: true,
      charCount: 500,
      contentStyle: 'generic'
    };
    let usageStats = {
      today: 0,
      month: 0,
      total: 0
    };

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
      currentCharCount = 500;
      currentContentStyle = 'generic';
      console.log('ğŸ”¥ ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”:', { currentCharCount, currentContentStyle });
      
      // localStorageì—ì„œ API í‚¤ ë³µì› (í”Œë˜ê·¸ ê°’ ì œì™¸)
      try {
        const storedApiKey = localStorage.getItem('geminiApiKey');
        if (storedApiKey && storedApiKey.length > 10 && storedApiKey !== 'API_KEY_AVAILABLE' && storedApiKey.startsWith('AIza')) {
          geminiApiKey = storedApiKey;
          console.log('âœ… localStorageì—ì„œ API í‚¤ ë³µì›:', storedApiKey.substring(0, 4) + '...');
        }
      } catch (error) {
        console.warn('localStorage API í‚¤ ë³µì› ì‹¤íŒ¨:', error);
      }
      
      loadKeywordDatabase();
      setupEventListeners();
      
      // AI ì„¤ì • ì´ˆê¸°í™”
      setTimeout(loadAiSettings, 1000);
      
      // AI ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      ['behaviorStyle', 'recordCount', 'includeActivities', 'useAiFallback', 'charCountSlider', 'contentStyle'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (id === 'charCountSlider') {
            element.addEventListener('input', function() {
              updateCharCount(this.value);
            });
          } else if (id === 'contentStyle') {
            element.addEventListener('change', function() {
              currentContentStyle = this.value;
              aiSettings.contentStyle = this.value;
              saveAiSettings();
            });
          } else {
            element.addEventListener('change', saveAiSettings);
          }
        }
      });
    });
    
    // ê¸€ììˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCharCount(value) {
      currentCharCount = parseInt(value);
      aiSettings.charCount = currentCharCount;
      document.getElementById('charCountDisplay').textContent = value;
      
      // ìŠ¬ë¼ì´ë” ìƒ‰ìƒ ë³€ê²½
      const slider = document.getElementById('charCountSlider');
      const percentage = ((value - 300) / (600 - 300)) * 100;
      slider.style.background = `linear-gradient(to right, #4285F4 0%, #4285F4 ${percentage}%, #ddd ${percentage}%, #ddd 100%)`;
      
      saveAiSettings();
    }

    // í‚¤ì›Œë“œ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ
    function loadKeywordDatabase() {
      google.script.run
        .withSuccessHandler(function(result) {
          keywordDatabase = result.categories;
          renderKeywords();
          updateStatistics();
        })
        .withFailureHandler(function(error) {
          console.error('í‚¤ì›Œë“œ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
          showAlert('í‚¤ì›Œë“œ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'warning');
        })
        .getKeywordDatabase();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ê²€ìƒ‰ ê¸°ëŠ¥
      document.getElementById('keywordSearch').addEventListener('input', function(e) {
        filterKeywords(e.target.value);
      });

      // ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
      ['observationContext', 'classActivity', 'specialProgram'].forEach(id => {
        document.getElementById(id).addEventListener('input', updatePreview);
      });
    }

    // íƒ­ ì „í™˜
    function showTab(tab) {
      // API í‚¤ ë¯¸ì„¤ì • ì‹œ ê²½ê³  (AI ì„¤ì • íƒ­ ì œì™¸)
      if (tab !== 'settings' && (!geminiApiKey || geminiApiKey === '')) {
        showAlert('âš ï¸ AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € AI ì„¤ì • íƒ­ì—ì„œ GEMINI API í‚¤ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”!', 'warning');
      }
      
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ í˜¸ì¶œëœ ê²½ìš°ì—ë§Œ event.target ì‚¬ìš©
      if (window.event && window.event.target) {
        window.event.target.classList.add('active');
      } else {
        // JavaScriptì—ì„œ ì§ì ‘ í˜¸ì¶œëœ ê²½ìš° íƒ­ ë²„íŠ¼ ì°¾ê¸°
        const targetButton = document.querySelector(`[onclick="showTab('${tab}')"]`);
        if (targetButton) {
          targetButton.classList.add('active');
        }
      }
      
      document.getElementById(tab + '-tab').classList.add('active');
    }

    // í‚¤ì›Œë“œ ë Œë”ë§
    function renderKeywords() {
      const grid = document.getElementById('keywordGrid');
      grid.innerHTML = '';
      
      const filteredCategories = currentCategory === 'all' 
        ? keywordDatabase 
        : keywordDatabase.filter(cat => cat.id === currentCategory);
      
      filteredCategories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'keyword-category fade-in';
        categoryDiv.innerHTML = `
          <div class="category-header" onclick="toggleCategory('${category.id}')">
            <div class="category-title">${category.name}</div>
            <div class="category-count">${category.keywords.length}ê°œ</div>
          </div>
          <div class="keyword-list" id="list-${category.id}">
            ${category.keywords.map(keyword => `
              <div class="keyword-item" data-keyword="${keyword.id}" data-category="${category.id}">
                <input type="checkbox" class="keyword-checkbox" id="${keyword.id}" 
                       onchange="toggleKeyword('${keyword.id}', '${category.id}')">
                <label class="keyword-label" for="${keyword.id}" title="${keyword.description}">
                  ${keyword.text}
                </label>
                <div class="keyword-intensity">
                  <button class="intensity-btn ${keyword.intensity === 1 ? 'active' : ''}" 
                          onclick="setIntensity('${keyword.id}', 1)">ì•½ê°„</button>
                  <button class="intensity-btn ${keyword.intensity === 2 ? 'active' : ''}" 
                          onclick="setIntensity('${keyword.id}', 2)">ë³´í†µ</button>
                  <button class="intensity-btn ${keyword.intensity === 3 ? 'active' : ''}" 
                          onclick="setIntensity('${keyword.id}', 3)">ë§¤ìš°</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        grid.appendChild(categoryDiv);
      });
    }

    // ì¹´í…Œê³ ë¦¬ í† ê¸€
    function toggleCategory(categoryId) {
      const list = document.getElementById(`list-${categoryId}`);
      list.classList.toggle('collapsed');
    }

    // ì¹´í…Œê³ ë¦¬ í•„í„°
    function filterCategory(category) {
      currentCategory = category;
      
      // í•„í„° ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.category-filter').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderKeywords();
      updateStatistics();
    }

    // í‚¤ì›Œë“œ ê²€ìƒ‰
    function filterKeywords(searchTerm) {
      const items = document.querySelectorAll('.keyword-item');
      let visibleCount = 0;
      
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm.toLowerCase())) {
          item.style.display = 'flex';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      document.getElementById('visibleCount').textContent = visibleCount;
    }

    // í‚¤ì›Œë“œ í† ê¸€
    function toggleKeyword(keywordId, categoryId) {
      const checkbox = document.getElementById(keywordId);
      const category = keywordDatabase.find(cat => cat.id === categoryId);
      const keyword = category.keywords.find(k => k.id === keywordId);
      
      if (checkbox.checked) {
        // í‚¤ì›Œë“œ ì¶”ê°€
        const selectedKeyword = {
          id: keywordId,
          keywordId: keywordId,  // Code.gsì—ì„œ ì°¾ëŠ” í•„ë“œ ì¶”ê°€
          categoryId: categoryId,
          text: keyword.text,
          autoText: keyword.autoText,
          intensity: 2, // ê¸°ë³¸ê°’
          color: category.color,
          context: ''  // ë§¥ë½ ì •ë³´ í•„ë“œ ì¶”ê°€
        };
        selectedKeywords.push(selectedKeyword);
      } else {
        // í‚¤ì›Œë“œ ì œê±°
        selectedKeywords = selectedKeywords.filter(k => k.id !== keywordId);
      }
      
      updateSelectedKeywords();
      updateStatistics();
      updatePreview();
    }

    // ê°•ë„ ì„¤ì •
    function setIntensity(keywordId, intensity) {
      const keyword = selectedKeywords.find(k => k.id === keywordId);
      if (keyword) {
        keyword.intensity = intensity;
      }
      
      // UI ì—…ë°ì´íŠ¸
      const keywordItem = document.querySelector(`[data-keyword="${keywordId}"]`);
      keywordItem.querySelectorAll('.intensity-btn').forEach(btn => btn.classList.remove('active'));
      keywordItem.querySelector(`.intensity-btn:nth-child(${intensity})`).classList.add('active');
      
      updateSelectedKeywords();
      updatePreview();
    }

    // ì„ íƒëœ í‚¤ì›Œë“œ ì—…ë°ì´íŠ¸
    function updateSelectedKeywords() {
      const container = document.getElementById('selectedKeywords');
      
      if (selectedKeywords.length === 0) {
        container.innerHTML = '<span style="color: #999;">í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>';
        return;
      }
      
      container.innerHTML = selectedKeywords.map(keyword => {
        const intensityText = ['', 'ì•½ê°„', 'ë³´í†µ', 'ë§¤ìš°'][keyword.intensity];
        return `
          <div class="keyword-badge" style="background-color: ${keyword.color}">
            ${keyword.text}
            <span class="intensity">${intensityText}</span>
            <span class="remove" onclick="removeKeyword('${keyword.id}')">Ã—</span>
          </div>
        `;
      }).join('');
    }

    // í‚¤ì›Œë“œ ì œê±°
    function removeKeyword(keywordId) {
      document.getElementById(keywordId).checked = false;
      selectedKeywords = selectedKeywords.filter(k => k.id !== keywordId);
      updateSelectedKeywords();
      updateStatistics();
      updatePreview();
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStatistics() {
      document.getElementById('selectedCount').textContent = selectedKeywords.length;
      
      const visibleItems = document.querySelectorAll('.keyword-item:not([style*="display: none"])');
      document.getElementById('visibleCount').textContent = visibleItems.length;
    }

    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (null ì²´í¬ ì¶”ê°€)
    function updatePreview() {
      const previewBox = document.getElementById('behaviorPreview');
      const copyBtn = document.getElementById('copyPreviewBtn');
      const complianceStatus = document.getElementById('complianceStatus');
      
      // null ì²´í¬ ì¶”ê°€
      if (!previewBox) {
        console.warn('behaviorPreview ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (selectedKeywords.length === 0) {
        previewBox.textContent = 'í‚¤ì›Œë“œë¥¼ ì„ íƒí•˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°ê°€ ìƒì„±ë©ë‹ˆë‹¤.';
        previewBox.classList.remove('has-content', 'ai-generated', 'basic-generated');
        if (copyBtn) copyBtn.classList.add('hidden');
        if (complianceStatus) complianceStatus.classList.add('hidden');
        return;
      }

      // ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ ê·¸ë£¹í™”
      const keywordsByCategory = selectedKeywords.reduce((acc, sk) => {
        if (!acc[sk.categoryId]) acc[sk.categoryId] = [];
        acc[sk.categoryId].push(sk);
        return acc;
      }, {});

      // í…ìŠ¤íŠ¸ ìƒì„±
      const sentences = [];
      Object.entries(keywordsByCategory).forEach(([categoryId, keywords]) => {
        const keywordTexts = keywords.map(sk => {
          const intensityModifiers = {
            1: { prefix: 'ì•½ê°„', suffix: '' },
            2: { prefix: '', suffix: '' },
            3: { prefix: 'ë§¤ìš°', suffix: '' }
          };
          
          const modifier = intensityModifiers[sk.intensity];
          let text = sk.autoText || sk.text;
          
          if (modifier.prefix) {
            text = `${modifier.prefix} ${text}`;
          }
          
          return text;
        });
        
        sentences.push(keywordTexts.join(', '));
      });

      // ë§¥ë½ ì •ë³´ ì¶”ê°€
      const context = document.getElementById('observationContext').value;
      const activity = document.getElementById('classActivity').value;
      const program = document.getElementById('specialProgram').value;

      let finalText = sentences.join('. ');
      
      if (context) finalText += ` ${context}ì—ì„œ`;
      if (activity) finalText += ` ${activity}ì„ í†µí•´`;
      if (program) finalText += ` ${program}ì— ì°¸ì—¬í•˜ë©°`;
      
      finalText += ' ì„±ì¥í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„.';

      previewBox.textContent = finalText;
      if (previewBox) previewBox.classList.add('has-content');
      if (copyBtn) copyBtn.classList.remove('hidden');
      
      // NEIS ê·œì • ê²€ì‚¬
      updateComplianceCheck(finalText);
      if (complianceStatus) complianceStatus.classList.remove('hidden');
    }

    // NEIS ê·œì • ê²€ì‚¬ (null ì²´í¬ ì¶”ê°€)
    function checkCompliance(text) {
      const lengthOk = text.length <= 500;
      const endingOk = ['í•¨', 'ì„', 'ë¨', 'ì„ ë³´ì„', 'í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„'].some(ending => text.endsWith(ending));
      const contentOk = !['í•™ìƒ ì´ë¦„', 'êµ¬ì²´ì  ë‚ ì§œ', 'ì‹œê°„ í‘œí˜„'].some(prohibited => text.includes(prohibited));
      
      // ê¸¸ì´ ê²€ì‚¬ (null ì²´í¬)
      const lengthIcon = document.getElementById('lengthIcon');
      const lengthCheck = document.getElementById('lengthCheck');
      if (lengthIcon && lengthCheck) {
        lengthIcon.className = `compliance-icon ${lengthOk ? 'pass' : 'fail'}`;
        lengthIcon.textContent = lengthOk ? 'âœ“' : 'âœ—';
        lengthCheck.textContent = `ê¸€ì ìˆ˜: ${text.length}/500ì ${lengthOk ? '(ì í•©)' : '(ì´ˆê³¼)'}`;
      }
      
      // ì¢…ê²°ì–´ ê²€ì‚¬ (null ì²´í¬)
      const endingIcon = document.getElementById('endingIcon');
      const endingCheck = document.getElementById('endingCheck');
      if (endingIcon && endingCheck) {
        endingIcon.className = `compliance-icon ${endingOk ? 'pass' : 'fail'}`;
        endingIcon.textContent = endingOk ? 'âœ“' : 'âœ—';
        endingCheck.textContent = `ëª…ì‚¬í˜• ì¢…ê²° ${endingOk ? '(ì í•©)' : '(ë¶€ì í•©)'}`;
      }
      
      // ë‚´ìš© ê²€ì‚¬ (null ì²´í¬)
      const contentIcon = document.getElementById('contentIcon');
      const contentCheck = document.getElementById('contentCheck');
      if (contentIcon && contentCheck) {
        contentIcon.className = `compliance-icon ${contentOk ? 'pass' : 'fail'}`;
        contentIcon.textContent = contentOk ? 'âœ“' : 'âœ—';
        contentCheck.textContent = `ê¸ˆì§€ ë‚´ìš© ${contentOk ? 'ì—†ìŒ' : 'í¬í•¨ë¨'}`;
      }
    }

    // ğŸ”¥ ëˆ„ë½ëœ updateComplianceIndicators í•¨ìˆ˜ ì¶”ê°€
    function updateComplianceIndicators(compliance) {
      if (!compliance) return;
      
      // í–‰ë™ë°œë‹¬ ë° íŠ¹ê¸°ì‚¬í•­ íƒ­ì˜ ê·œì • ê²€ì‚¬ ê²°ê³¼ ì—…ë°ì´íŠ¸
      const behaviorComplianceEl = document.querySelector('#behavior-tab .compliance-check');
      if (behaviorComplianceEl) {
        const isCompliant = compliance.lengthOk && compliance.endingOk && compliance.contentOk;
        behaviorComplianceEl.className = `compliance-check ${isCompliant ? 'compliant' : 'non-compliant'}`;
        behaviorComplianceEl.innerHTML = `
          <div class="compliance-item">
            <span class="compliance-icon ${compliance.lengthOk ? 'pass' : 'fail'}">${compliance.lengthOk ? 'âœ“' : 'âœ—'}</span>
            ê¸€ì ìˆ˜: ${compliance.length || 0}/500ì ${compliance.lengthOk ? '(ì í•©)' : '(ì´ˆê³¼)'}
          </div>
          <div class="compliance-item">
            <span class="compliance-icon ${compliance.endingOk ? 'pass' : 'fail'}">${compliance.endingOk ? 'âœ“' : 'âœ—'}</span>
            ëª…ì‚¬í˜• ì¢…ê²° ${compliance.endingOk ? '(ì í•©)' : '(ë¶€ì í•©)'}
          </div>
          <div class="compliance-item">
            <span class="compliance-icon ${compliance.contentOk ? 'pass' : 'fail'}">${compliance.contentOk ? 'âœ“' : 'âœ—'}</span>
            ê¸ˆì§€ ë‚´ìš© ${compliance.contentOk ? 'ì—†ìŒ' : 'í¬í•¨ë¨'}
          </div>
        `;
      }
    }

    // ğŸ‘¨â€ğŸ“ í•™ìƒ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ
    let savedStudents = {}; // {studentId: {number, name, behaviorText, compliance, keywords}}
    
    // í•™ìƒ ì •ë³´ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    function initializeStudentForm() {
      const studentNumberInput = document.getElementById('studentNumber');
      const studentNameInput = document.getElementById('studentName');
      
      if (studentNumberInput && studentNameInput) {
        studentNumberInput.addEventListener('input', updateStudentInfo);
        studentNameInput.addEventListener('input', updateStudentInfo);
      }
    }
    
    // í•™ìƒ ì •ë³´ ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
    function updateStudentInfo() {
      const studentNumber = document.getElementById('studentNumber').value;
      const studentName = document.getElementById('studentName').value;
      const display = document.getElementById('studentInfoDisplay');
      
      if (studentNumber && studentName) {
        display.style.display = 'block';
        display.querySelector('.student-number-badge').textContent = `${studentNumber}ë²ˆ`;
        display.querySelector('.student-name-badge').textContent = studentName;
      } else {
        display.style.display = 'none';
      }
    }
    
    // í˜„ì¬ í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getCurrentStudentInfo() {
      const studentNumber = document.getElementById('studentNumber').value;
      const studentName = document.getElementById('studentName').value;
      
      if (!studentNumber || !studentName) {
        showAlert('í•™ìƒ ë²ˆí˜¸ì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return null;
      }
      
      return {
        number: parseInt(studentNumber),
        name: studentName.trim(),
        id: `${studentNumber}_${studentName.trim()}`
      };
    }
    
    // í•™ìƒë³„ í–‰ë™íŠ¹ì„± ì €ì¥
    function saveStudentBehaviorData(studentInfo, behaviorText, compliance = null, keywords = []) {
      if (!studentInfo || !behaviorText) return false;
      
      savedStudents[studentInfo.id] = {
        number: studentInfo.number,
        name: studentInfo.name,
        behaviorText: behaviorText,
        compliance: compliance,
        keywords: keywords,
        savedAt: new Date().toISOString()
      };
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem('nugabar_saved_students', JSON.stringify(savedStudents));
      
      console.log(`âœ… í•™ìƒ ë°ì´í„° ì €ì¥ ì™„ë£Œ: ${studentInfo.name} (${studentInfo.number}ë²ˆ)`);
      return true;
    }
    
    // ì €ì¥ëœ í•™ìƒ ë°ì´í„° ë¡œë“œ
    function loadSavedStudents() {
      try {
        const saved = localStorage.getItem('nugabar_saved_students');
        if (saved) {
          savedStudents = JSON.parse(saved);
          console.log(`ğŸ“š ì €ì¥ëœ í•™ìƒ ë°ì´í„° ë¡œë“œ: ${Object.keys(savedStudents).length}ëª…`);
        }
      } catch (error) {
        console.error('ì €ì¥ëœ í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        savedStudents = {};
      }
    }
    
    // ì €ì¥ëœ í•™ìƒ ëª©ë¡ í‘œì‹œ
    function displaySavedStudents() {
      // ëˆ„ê°€ê¸°ë¡ íƒ­ì— ì €ì¥ëœ í•™ìƒ ëª©ë¡ í‘œì‹œìš© í•¨ìˆ˜
      return Object.values(savedStudents).sort((a, b) => a.number - b.number);
    }
    
    // ğŸ“š ëˆ„ê°€ê¸°ë¡ íƒ­ - í•™ìƒ ëª©ë¡ í‘œì‹œ ë° ê´€ë¦¬
    function refreshStudentsList() {
      const container = document.getElementById('savedStudentsContainer');
      const noMessage = document.getElementById('noStudentsMessage');
      const studentsList = document.getElementById('studentsList');
      
      if (!container) return;
      
      const students = Object.values(savedStudents).sort((a, b) => a.number - b.number);
      
      if (students.length === 0) {
        noMessage.style.display = 'block';
        studentsList.style.display = 'none';
        return;
      }
      
      noMessage.style.display = 'none';
      studentsList.style.display = 'block';
      
      studentsList.innerHTML = students.map(student => `
        <div class="student-item" data-student-id="${student.number}_${student.name}">
          <div class="student-info">
            <input type="checkbox" class="student-checkbox" value="${student.number}_${student.name}" checked>
            <span class="student-number-badge">${student.number}ë²ˆ</span>
            <span class="student-name-badge">${student.name}</span>
            <small style="color: #666;">
              ì €ì¥ì¼: ${new Date(student.savedAt).toLocaleDateString()}
            </small>
          </div>
          <div class="student-actions">
            <button class="btn-small btn-edit" onclick="editStudentData('${student.number}_${student.name}')">ìˆ˜ì •</button>
            <button class="btn-small btn-delete" onclick="deleteStudentData('${student.number}_${student.name}')">ì‚­ì œ</button>
          </div>
        </div>
      `).join('');
      
      console.log(`ğŸ“š í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ: ${students.length}ëª…`);
    }
    
    // í•™ìƒ ë°ì´í„° ì‚­ì œ
    function deleteStudentData(studentId) {
      if (!confirm('ì´ í•™ìƒì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      delete savedStudents[studentId];
      localStorage.setItem('nugabar_saved_students', JSON.stringify(savedStudents));
      refreshStudentsList();
      showAlert('í•™ìƒ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í•™ìƒ ë°ì´í„° í¸ì§‘ (í–¥í›„ êµ¬í˜„)
    function editStudentData(studentId) {
      showAlert('í¸ì§‘ ê¸°ëŠ¥ì€ í–¥í›„ ì—…ë°ì´íŠ¸ì—ì„œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.', 'info');
    }
    
    // ì„ íƒëœ í•™ìƒë“¤ ê°€ì ¸ì˜¤ê¸°
    function getSelectedStudents() {
      const generationType = document.querySelector('input[name="generationType"]:checked').value;
      
      if (generationType === 'all') {
        return Object.values(savedStudents).sort((a, b) => a.number - b.number);
      } else {
        const checkboxes = document.querySelectorAll('.student-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        return selectedIds.map(id => savedStudents[id]).filter(Boolean);
      }
    }
    
    // í•™ìƒë³„ ëˆ„ê°€ê¸°ë¡ ìƒì„±
    function generateStudentRecords() {
      const selectedStudents = getSelectedStudents();
      
      if (selectedStudents.length === 0) {
        showAlert('ìƒì„±í•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      // API í‚¤ ìƒíƒœ í™•ì¸ (ë°±ì—”ë“œì—ì„œ ê´€ë¦¬)
      if (!geminiApiKey || geminiApiKey === '') {
        showAlert('GEMINI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. AI ì„¤ì • íƒ­ì—ì„œ API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      console.log('ğŸ” API í‚¤ ìƒíƒœ í™•ì¸ ì™„ë£Œ - ë°±ì—”ë“œì—ì„œ ê´€ë¦¬ë¨');
      
      const recordCount = parseInt(document.getElementById('recordCount').value) || 5;
      
      // ë‚ ì§œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
      const dateSettings = {
        year: parseInt(document.getElementById('recordYear').value) || 2025,
        startMonth: parseInt(document.getElementById('recordStartMonth').value) || 3,
        endMonth: parseInt(document.getElementById('recordEndMonth').value) || 7
      };
      
      console.log(`ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„± ì‹œì‘: ${selectedStudents.length}ëª…, ê° ${recordCount}ê°œ`);
      console.log('ğŸ“ ì„ íƒëœ í•™ìƒ ë°ì´í„°:', selectedStudents);
      console.log(`ğŸ“… ë‚ ì§œ ì„¤ì •: ${dateSettings.year}ë…„ ${dateSettings.startMonth}ì›”~${dateSettings.endMonth}ì›”`);
      
      // í•™ìƒ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
      for (let i = 0; i < selectedStudents.length; i++) {
        const student = selectedStudents[i];
        console.log(`ğŸ“ í•™ìƒ ${i + 1} ë°ì´í„°:`, {
          number: student.number,
          name: student.name,
          hasBehaviorText: !!student.behaviorText,
          behaviorTextLength: student.behaviorText ? student.behaviorText.length : 0,
          behaviorTextPreview: student.behaviorText ? student.behaviorText.substring(0, 50) + '...' : 'NONE'
        });
        
        if (!student.behaviorText) {
          showAlert(`${student.name} í•™ìƒì˜ í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í–‰ë™íŠ¹ì„±ì„ ìƒì„±í•´ì£¼ì„¸ìš”.`, 'error');
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„±';
          return;
        }
      }
      
      const generateBtn = document.querySelector('button[onclick="generateStudentRecords()"]');
      generateBtn.disabled = true;
      generateBtn.innerHTML = 'â³ ìƒì„± ì¤‘...';
      
      // ğŸ”„ í–¥ìƒëœ ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      showLoadingProgress(
        `ğŸ“ ${selectedStudents.length}ëª…ì˜ ëˆ„ê°€ê¸°ë¡ ìƒì„± ì¤‘...`,
        `í•™ìƒë³„ ${recordCount}ê°œì”© ì´ ${selectedStudents.length * recordCount}ê°œì˜ ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•©ë‹ˆë‹¤.`
      );
      
      console.log('ğŸš€ ëˆ„ê°€ê¸°ë¡ ìƒì„± ì§ì ‘ ì‹œì‘');
      console.log('ğŸš€ ì „ì†¡í•  í•™ìƒ ë°ì´í„°:', selectedStudents);
      console.log('ğŸš€ ëˆ„ê°€ê¸°ë¡ ê°œìˆ˜:', recordCount);
      
      // ğŸ”¥ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ëˆ„ê°€ê¸°ë¡ ìƒì„± (ë°±ì—”ë“œ null ì‘ë‹µ ë¬¸ì œ ìš°íšŒ)
      generateCumulativeRecordsDirectly(selectedStudents, recordCount, dateSettings)
        .then(function(result) {
          console.log('ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ìƒì„± ì™„ë£Œ:', result);
          
          // ğŸ”„ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
          hideLoadingProgress();
          
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„±';
          
          if (result && result.success === true) {
            console.log('âœ… ì„±ê³µ ì‘ë‹µ - ê²°ê³¼ í‘œì‹œ ì¤‘');
            console.log('ğŸ¯ ë°›ì€ result ì „ì²´:', result);
            console.log('ğŸ¯ result.records:', result.records);
            
            // records ë°°ì—´ ê²€ì¦
            if (!Array.isArray(result.records)) {
              console.error('âŒ recordsê°€ ë°°ì—´ì´ ì•„ë‹˜:', result.records);
              showAlert('ëˆ„ê°€ê¸°ë¡ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
              return;
            }
            
            if (result.records.length === 0) {
              console.warn('âš ï¸ ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡ì´ ì—†ìŒ');
              showAlert('ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
              return;
            }
            
            // ëˆ„ê°€ê¸°ë¡ ìƒì„± íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
            console.log('ğŸ”„ records íƒ­ìœ¼ë¡œ ì „í™˜ ì¤‘...');
            showTab('records');
            console.log('ğŸ”„ íƒ­ ì „í™˜ ì™„ë£Œ');
            
            // ê²°ê³¼ í‘œì‹œ
            console.log('ğŸ“‹ displayGeneratedRecords í˜¸ì¶œ ì¤‘...');
            try {
              displayGeneratedRecords(result.records);
              console.log('ğŸ“‹ displayGeneratedRecords í˜¸ì¶œ ì™„ë£Œ');
            } catch (error) {
              console.error('ğŸ’¥ displayGeneratedRecords ì˜¤ë¥˜:', error);
              console.error('ğŸ’¥ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
              showAlert('ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
            
            showAlert(`âœ… ${selectedStudents.length}ëª…ì˜ ëˆ„ê°€ê¸°ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          } else {
            console.error('âŒ ì‹¤íŒ¨ ì‘ë‹µ:', result);
            const errorMessage = result?.message || result?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            showAlert('ëˆ„ê°€ê¸°ë¡ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage, 'error');
          }
        })
        .catch(function(error) {
          hideLoadingProgress();
          
          console.error('ğŸ’¥ í”„ë¡ íŠ¸ì—”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
          
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„±';
          
          showAlert('ëˆ„ê°€ê¸°ë¡ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        });
    }
    
    // ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡ í‘œì‹œ
    function displayGeneratedRecords(records) {
      try {
        console.log('ğŸ¯ displayGeneratedRecords ì‹œì‘');
        console.log('ğŸ¯ ë°›ì€ records ë°ì´í„°:', records);
        console.log('ğŸ¯ records íƒ€ì…:', typeof records);
        console.log('ğŸ¯ records ê¸¸ì´:', records?.length);
        
        const recordsList = document.getElementById('recordsList');
        console.log('ğŸ¯ recordsList ìš”ì†Œ:', recordsList);
        
        if (!recordsList) {
          console.error('âŒ recordsList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          return;
        }
        
        if (!records) {
          console.error('âŒ records ë°ì´í„°ê°€ ì—†ìŒ');
          return;
        }
        
        if (!Array.isArray(records)) {
          console.error('âŒ recordsê°€ ë°°ì—´ì´ ì•„ë‹˜:', records);
          return;
        }
        
        if (records.length === 0) {
          console.error('âŒ records ë°°ì—´ì´ ë¹„ì–´ìˆìŒ');
          recordsList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">ìƒì„±ëœ ëˆ„ê°€ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        
        console.log('âœ… records ë°ì´í„° ìœ íš¨ì„± í™•ì¸ ì™„ë£Œ');
        
        // ê° í•™ìƒ ë°ì´í„° ìƒì„¸ ê²€ì¦
        for (let i = 0; i < records.length; i++) {
          console.log(`ğŸ” í•™ìƒ ${i + 1} ìƒì„¸ ë°ì´í„°:`, records[i]);
          console.log(`ğŸ” studentNumber:`, records[i]?.studentNumber);
          console.log(`ğŸ” studentName:`, records[i]?.studentName);
          console.log(`ğŸ” records:`, records[i]?.records);
          if (records[i]?.records) {
            console.log(`ğŸ” records íƒ€ì…:`, typeof records[i].records);
            console.log(`ğŸ” records ê¸¸ì´:`, records[i].records.length);
          }
        }
        
        recordsList.innerHTML = records.map((studentRecords, index) => {
          console.log(`ğŸ¯ HTML ìƒì„± ì¤‘ - í•™ìƒ ${index + 1}:`, studentRecords);
          
          return `
            <div class="record-group" style="background: #ffffff; border: 2px solid #e3f2fd; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.2rem; padding-bottom: 0.8rem; border-bottom: 1px solid #e3f2fd;">
                <h4 style="color: #333; margin: 0; font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem;">
                  <span style="background: #ffffff; color: #1976D2; border: 2px solid #1976D2; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600;">${studentRecords.studentNumber}ë²ˆ</span>
                  <span style="background: #ffffff; color: #34A853; border: 2px solid #34A853; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600;">${studentRecords.studentName}</span>
                  <span style="color: #666; font-size: 1.1rem; font-weight: 500;">ëˆ„ê°€ê¸°ë¡</span>
                </h4>
                <button onclick="copyStudentRecords(${index})" class="copy-student-btn" style="background: linear-gradient(135deg, #ff7043, #ff8a65); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 112, 67, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 112, 67, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 112, 67, 0.3)'">
                  ğŸ“‹ ì „ì²´ ë³µì‚¬
                </button>
              </div>
              <div class="records-container">
                ${studentRecords.records.map((record, recordIndex) => {
                  // ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬: ê°ì²´ì¸ ê²½ìš° text í•„ë“œ ì‚¬ìš©, ë¬¸ìì—´ì¸ ê²½ìš° ì§ì ‘ ì‚¬ìš©
                  let cleanRecord = '';
                  let displayDate = '';
                  
                  if (typeof record === 'object' && record.text) {
                    cleanRecord = record.text;
                    displayDate = record.date || '';
                  } else if (typeof record === 'string') {
                    cleanRecord = record;
                  }
                  
                  // JSON í˜•ì‹ í…ìŠ¤íŠ¸ ì •ë¦¬ (ê°•í™”ëœ ë²„ì „)
                  if (typeof cleanRecord === 'string') {
                    // 1ì°¨ ì‹œë„: JSON í˜•íƒœ íƒì§€ ë° íŒŒì‹±
                    if (cleanRecord.includes('{"record":') || cleanRecord.includes("{'record':") || cleanRecord.includes('record":') || cleanRecord.includes("record':")) {
                      try {
                        // JSON íŒŒì‹± ì‹œë„
                        const parsed = JSON.parse(cleanRecord);
                        cleanRecord = parsed.record || parsed.text || cleanRecord;
                        console.log('âœ… í´ë¼ì´ì–¸íŠ¸ JSON íŒŒì‹± ì„±ê³µ:', cleanRecord.substring(0, 50) + '...');
                      } catch (e) {
                        console.log('âš ï¸ í´ë¼ì´ì–¸íŠ¸ JSON íŒŒì‹± ì‹¤íŒ¨, ì •ê·œì‹ ì‹œë„');
                        
                        // 2ì°¨ ì‹œë„: ë‹¤ì–‘í•œ ì •ê·œì‹ íŒ¨í„´ìœ¼ë¡œ ì¶”ì¶œ
                        const patterns = [
                          /"record":\s*"([^"]+)"/,
                          /'record':\s*'([^']+)'/,
                          /record["']?\s*:\s*["']([^"']+)["']/,
                          /"([^"]*(?:í•˜ëŠ”|í•˜ë©°|ë³´ì„|ë‚˜íƒ€ë‚¨|ë¨|í•¨|ìŒ)(?:\.|$)[^"]*)"/
                        ];
                        
                        let extracted = false;
                        for (let pattern of patterns) {
                          const match = cleanRecord.match(pattern);
                          if (match && match[1] && match[1].length > 10) {
                            cleanRecord = match[1];
                            console.log('âœ… ì •ê·œì‹ ì¶”ì¶œ ì„±ê³µ:', cleanRecord.substring(0, 50) + '...');
                            extracted = true;
                            break;
                          }
                        }
                        
                        if (!extracted) {
                          console.log('âš ï¸ ëª¨ë“  ì¶”ì¶œ ë°©ë²• ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©');
                          // ë§ˆì§€ë§‰ ì •ë¦¬: JSON í˜•íƒœì˜ ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±°
                          cleanRecord = cleanRecord.replace(/^[{"']+|[}"']+$/g, '')
                                             .replace(/record["']?\s*:\s*["']?/g, '')
                                             .replace(/\\n/g, ' ')
                                             .replace(/\\"|\\'/g, '"')
                                             .trim();
                        }
                      }
                    }
                    
                    // ì¶”ê°€ ì •ë¦¬: ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±° ë° ê³µë°± ì •ë¦¬
                    cleanRecord = cleanRecord.replace(/\\n/g, ' ')
                                           .replace(/\\t/g, ' ')
                                           .replace(/\s+/g, ' ')
                                           .replace(/^\s+|\s+$/g, '')
                                           .trim();
                  }
                  
                  return `
                    <div class="record-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; padding-bottom: 0.6rem; border-bottom: 1px solid #f0f0f0;">
                        <div class="record-header" style="font-weight: 700; color: #1976d2; font-size: 1.2rem; display: flex; align-items: center; gap: 0.8rem;">
                          <span style="background: #1976d2; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600;">${recordIndex + 1}</span>
                          <span>ëˆ„ê°€ê¸°ë¡</span>
                          ${displayDate ? `<span style="background: #e3f2fd; color: #1976d2; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.85rem; font-weight: 500;">${displayDate}</span>` : ''}
                        </div>
                        <button onclick="copyRecord(\`${cleanRecord.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, ${index}, ${recordIndex})" class="copy-record-btn" style="background: linear-gradient(135deg, #43a047, #66bb6a); color: white; border: none; padding: 0.5rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(67, 160, 71, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(67, 160, 71, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(67, 160, 71, 0.3)'">
                          ğŸ“‹ ë³µì‚¬
                        </button>
                      </div>
                      <div class="record-content" style="color: #2c3e50; line-height: 1.7; font-size: 1rem; padding: var(--space-md); background: #f8f9fa; border-radius: 8px; text-align: left; word-break: keep-all; letter-spacing: 0.2px; margin: 0; border: 1px solid #e9ecef; white-space: normal;">
                        ${cleanRecord.trim()}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');
        
        console.log('ğŸ¯ HTML ìƒì„± ì™„ë£Œ, innerHTML ê¸¸ì´:', recordsList.innerHTML.length);
        console.log('âœ… displayGeneratedRecords ì™„ë£Œ');
        
        // ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
        const copyAllBtn = document.getElementById('copyAllRecordsBtn');
        if (copyAllBtn) {
          copyAllBtn.style.display = 'inline-block';
        }
        
        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë³µì‚¬ ê¸°ëŠ¥ìš©)
        window.currentRecords = records;
        
      } catch (error) {
        console.error('ğŸ’¥ displayGeneratedRecords ë‚´ë¶€ ì˜¤ë¥˜:', error);
        console.error('ğŸ’¥ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        console.error('ğŸ’¥ ë°›ì€ ë°ì´í„°:', records);
        
        // ì•ˆì „í•œ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
        const recordsList = document.getElementById('recordsList');
        if (recordsList) {
          recordsList.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #e74c3c;">
              <h3>âš ï¸ ê²°ê³¼ í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
              <p>ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (F12)</p>
              <p>ì˜¤ë¥˜: ${error.message}</p>
            </div>
          `;
        }
      }
    }
    
    // ğŸ’¼ ë³µì‚¬ ê¸°ëŠ¥ë“¤
    
    // ê°œë³„ ëˆ„ê°€ê¸°ë¡ ë³µì‚¬
    function copyRecord(text, studentIndex, recordIndex) {
      try {
        navigator.clipboard.writeText(text).then(() => {
          showAlert(`ğŸ“‹ ëˆ„ê°€ê¸°ë¡ ${recordIndex + 1}ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          
          // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ (ì‹œê°ì  í”¼ë“œë°±)
          const btn = event.target;
          const originalBg = btn.style.background;
          btn.style.background = '#28a745';
          btn.innerHTML = 'âœ… ë³µì‚¬ë¨';
          setTimeout(() => {
            btn.style.background = originalBg;
            btn.innerHTML = 'ë³µì‚¬';
          }, 1500);
        }).catch(err => {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
          showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'error');
        });
      } catch (error) {
        console.error('ë³µì‚¬ ì˜¤ë¥˜:', error);
        showAlert('ë³µì‚¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      }
    }
    
    // íŠ¹ì • í•™ìƒì˜ ëª¨ë“  ëˆ„ê°€ê¸°ë¡ ë³µì‚¬
    function copyStudentRecords(studentIndex) {
      try {
        if (!window.currentRecords || !window.currentRecords[studentIndex]) {
          showAlert('ë³µì‚¬í•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        
        const student = window.currentRecords[studentIndex];
        let copyText = `${student.studentNumber}ë²ˆ ${student.studentName} - ëˆ„ê°€ê¸°ë¡\n\n`;
        
        student.records.forEach((record, index) => {
          // ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬: ê°ì²´ì¸ ê²½ìš° text í•„ë“œ ì‚¬ìš©, ë¬¸ìì—´ì¸ ê²½ìš° ì§ì ‘ ì‚¬ìš©
          let cleanRecord = '';
          if (typeof record === 'object' && record.text) {
            cleanRecord = record.text;
          } else if (typeof record === 'string') {
            cleanRecord = record;
          }
          
          // JSON í˜•ì‹ ì •ë¦¬ (ê°•í™”ëœ ë²„ì „)
          if (typeof cleanRecord === 'string') {
            if (cleanRecord.includes('{"record":') || cleanRecord.includes("{'record':") || cleanRecord.includes('record":') || cleanRecord.includes("record':")) {
              try {
                const parsed = JSON.parse(cleanRecord);
                cleanRecord = parsed.record || parsed.text || cleanRecord;
              } catch (e) {
                // ë‹¤ì–‘í•œ ì •ê·œì‹ íŒ¨í„´ìœ¼ë¡œ ì¶”ì¶œ
                const patterns = [
                  /"record":\s*"([^"]+)"/,
                  /'record':\s*'([^']+)'/,
                  /record["']?\s*:\s*["']([^"']+)["']/,
                  /"([^"]*(?:í•˜ëŠ”|í•˜ë©°|ë³´ì„|ë‚˜íƒ€ë‚¨|ë¨|í•¨|ìŒ)(?:\\.|$)[^"]*)"/
                ];
                
                for (let pattern of patterns) {
                  const match = cleanRecord.match(pattern);
                  if (match && match[1] && match[1].length > 10) {
                    cleanRecord = match[1];
                    break;
                  }
                }
              }
            }
            // ì¶”ê°€ ì •ë¦¬: ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±° ë° ê³µë°± ì •ë¦¬
            cleanRecord = cleanRecord.replace(/\\n/g, ' ')
                                   .replace(/\\t/g, ' ')
                                   .replace(/\s+/g, ' ')
                                   .replace(/^\s+|\s+$/g, '')
                                   .trim();
          }
          
          // ë‚ ì§œ ì œì™¸í•˜ê³  ëˆ„ê°€ê¸°ë¡ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬
          copyText += `ëˆ„ê°€ê¸°ë¡ ${index + 1}:\n${cleanRecord}\n\n`;
        });
        
        navigator.clipboard.writeText(copyText).then(() => {
          showAlert(`ğŸ“‹ ${student.studentName} í•™ìƒì˜ ëª¨ë“  ëˆ„ê°€ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          
          // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°±
          const btn = event.target;
          const originalBg = btn.style.background;
          const originalText = btn.innerHTML;
          btn.style.background = '#28a745';
          btn.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ';
          setTimeout(() => {
            btn.style.background = originalBg;
            btn.innerHTML = originalText;
          }, 2000);
        }).catch(err => {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
          showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        });
      } catch (error) {
        console.error('í•™ìƒ ê¸°ë¡ ë³µì‚¬ ì˜¤ë¥˜:', error);
        showAlert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }
    
    // ì „ì²´ ëˆ„ê°€ê¸°ë¡ ë³µì‚¬ (ê¸°ì¡´ í•¨ìˆ˜ ê°œì„ )
    function copyAllRecords() {
      try {
        if (!window.currentRecords || window.currentRecords.length === 0) {
          showAlert('ë³µì‚¬í•  ëˆ„ê°€ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
          return;
        }
        
        let allRecordsText = 'ëˆ„ê°€ê¸°ë¡ ì „ì²´\n' + '='.repeat(50) + '\n\n';
        
        window.currentRecords.forEach((student, studentIndex) => {
          allRecordsText += `${student.studentNumber}ë²ˆ ${student.studentName}\n`;
          allRecordsText += '-'.repeat(30) + '\n';
          
          student.records.forEach((record, recordIndex) => {
            // ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬: ê°ì²´ì¸ ê²½ìš° text í•„ë“œ ì‚¬ìš©, ë¬¸ìì—´ì¸ ê²½ìš° ì§ì ‘ ì‚¬ìš©
            let cleanRecord = '';
            if (typeof record === 'object' && record.text) {
              cleanRecord = record.text;
            } else if (typeof record === 'string') {
              cleanRecord = record;
            }
            
            // JSON í˜•ì‹ ì •ë¦¬ (ê°•í™”ëœ ë²„ì „)
            if (typeof cleanRecord === 'string') {
              if (cleanRecord.includes('{"record":') || cleanRecord.includes("{'record':") || cleanRecord.includes('record":') || cleanRecord.includes("record':")) {
                try {
                  const parsed = JSON.parse(cleanRecord);
                  cleanRecord = parsed.record || parsed.text || cleanRecord;
                } catch (e) {
                  // ë‹¤ì–‘í•œ ì •ê·œì‹ íŒ¨í„´ìœ¼ë¡œ ì¶”ì¶œ
                  const patterns = [
                    /"record":\s*"([^"]+)"/,
                    /'record':\s*'([^']+)'/,
                    /record["']?\s*:\s*["']([^"']+)["']/,
                    /"([^"]*(?:í•˜ëŠ”|í•˜ë©°|ë³´ì„|ë‚˜íƒ€ë‚¨|ë¨|í•¨|ìŒ)(?:\\.|$)[^"]*)"/
                  ];
                  
                  for (let pattern of patterns) {
                    const match = cleanRecord.match(pattern);
                    if (match && match[1] && match[1].length > 10) {
                      cleanRecord = match[1];
                      break;
                    }
                  }
                }
              }
              // ì¶”ê°€ ì •ë¦¬: ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±° ë° ê³µë°± ì •ë¦¬
              cleanRecord = cleanRecord.replace(/\\n/g, ' ')
                                     .replace(/\\t/g, ' ')
                                     .replace(/\s+/g, ' ')
                                     .replace(/^\s+|\s+$/g, '')
                                     .trim();
            }
            
            allRecordsText += `${recordIndex + 1}. ${cleanRecord}\n`;
          });
          
          allRecordsText += '\n';
        });
        
        navigator.clipboard.writeText(allRecordsText).then(() => {
          showAlert(`ğŸ“‹ ì „ì²´ ëˆ„ê°€ê¸°ë¡(${window.currentRecords.length}ëª…)ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
        }).catch(err => {
          console.error('ì „ì²´ ë³µì‚¬ ì‹¤íŒ¨:', err);
          showAlert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        });
      } catch (error) {
        console.error('ì „ì²´ ë³µì‚¬ ì˜¤ë¥˜:', error);
        showAlert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      loadSavedStudents();
      initializeStudentForm();
      
      // íƒ­ ì „í™˜ ì‹œ í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      setTimeout(refreshStudentsList, 500);
    });
    
    // showTab í•¨ìˆ˜ í™•ì¥ - records íƒ­ ì„ íƒ ì‹œ í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    const originalShowTab = window.showTab;
    window.showTab = function(tab) {
      if (originalShowTab) originalShowTab(tab);
      if (tab === 'records') {
        setTimeout(refreshStudentsList, 100);
      }
    };

    // ğŸ”¥ switchTab í•¨ìˆ˜ - showTabê³¼ ì¼ê´€ì„± ìœ ì§€
    function switchTab(tabName) {
      console.log(`ğŸ”„ switchTab í•¨ìˆ˜ í˜¸ì¶œë¨ - ëŒ€ìƒ íƒ­: ${tabName}`);
      
      // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // ëª¨ë“  íƒ­ ì½˜í…ì¸  ë¹„í™œì„±í™” (CSS .active í´ë˜ìŠ¤ ì‚¬ìš©)
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
      const targetButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
      if (targetButton) {
        targetButton.classList.add('active');
        console.log(`âœ… íƒ­ ë²„íŠ¼ í™œì„±í™” ì™„ë£Œ: ${tabName}`);
      } else {
        console.error(`âŒ íƒ­ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${tabName}`);
      }
      
      // ì„ íƒëœ íƒ­ ì½˜í…ì¸  í™œì„±í™” (CSS .active í´ë˜ìŠ¤ ì‚¬ìš©)
      const targetContent = document.getElementById(`${tabName}-tab`);
      if (targetContent) {
        targetContent.classList.add('active');
        console.log(`âœ… íƒ­ ì½˜í…ì¸  í‘œì‹œ ì™„ë£Œ: ${tabName}-tab`);
      } else {
        console.error(`âŒ íƒ­ ì½˜í…ì¸ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${tabName}-tab`);
      }
    }

    // ğŸ¯ í–‰ë™ë°œë‹¬ ë° íŠ¹ê¸°ì‚¬í•­ íƒ­ ë‚´ìš© ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateBehaviorTabContent(text, isAI = false, compliance = null) {
      const behaviorTextArea = document.getElementById('behaviorTextInput');
      if (behaviorTextArea) {
        behaviorTextArea.value = text;
      }
      
      // í–‰ë™ë°œë‹¬ ë° íŠ¹ê¸°ì‚¬í•­ íƒ­ì— ìƒì„±ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
      const behaviorTab = document.getElementById('behavior-tab');
      if (behaviorTab) {
        // ê¸°ì¡´ ìƒì„± ê²°ê³¼ ì˜ì—­ ì°¾ê¸° ë˜ëŠ” ìƒì„±
        let resultContainer = behaviorTab.querySelector('.generated-result-container');
        if (!resultContainer) {
          resultContainer = document.createElement('div');
          resultContainer.className = 'generated-result-container';
          resultContainer.style.marginTop = '1.5rem';
          
          // í…ìŠ¤íŠ¸ ì˜ì—­ ì•ì— ì¶”ê°€
          const textArea = behaviorTab.querySelector('#behaviorTextInput');
          if (textArea && textArea.parentNode) {
            textArea.parentNode.insertBefore(resultContainer, textArea);
          } else {
            behaviorTab.appendChild(resultContainer);
          }
        }
        
        // ìƒì„± ê²°ê³¼ í‘œì‹œ
        resultContainer.innerHTML = `
          <div class="record-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <h4 style="margin: 0; color: #34A853;">ğŸ“‹ ìƒì„±ëœ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬</h4>
              <div class="generation-badge ${isAI ? 'ai-badge' : 'basic-badge'}">
                ${isAI ? 'ğŸ¤– AI ì „ë¬¸ ìƒì„±' : 'ğŸ“ ê¸°ë³¸ ìƒì„±'}
              </div>
            </div>
            <button class="copy-button-small" onclick="copyToClipboard('${text.replace(/'/g, "\\'")}', 'í–‰ë™íŠ¹ì„±')">
              ğŸ“‹ ë³µì‚¬
            </button>
          </div>
          <div class="record-content ${isAI ? 'ai-generated' : 'basic-generated'}">
            ${text}
          </div>
          <div class="record-meta">
            <span>ê¸€ììˆ˜: ${text.length}ì</span>
            <span>ìƒì„±ì‹œê°„: ${new Date().toLocaleTimeString()}</span>
            ${compliance ? `<span class="compliance-badge ${compliance.lengthOk && compliance.endingOk && compliance.contentOk ? 'compliant' : 'warning'}">
              ${compliance.lengthOk && compliance.endingOk && compliance.contentOk ? 'âœ… NEIS ê·œì • ì¤€ìˆ˜' : 'âš ï¸ ê²€í†  í•„ìš”'}
            </span>` : ''}
          </div>
        `;
        
        // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // ê·œì • ê²€ì‚¬ ê²°ê³¼ ì—…ë°ì´íŠ¸
        if (compliance) {
          updateComplianceIndicators(compliance);
        }
      }
    }

    // ğŸš€ AI ìƒì„± í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê°œì„ ëœ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateBehaviorPreview(text, isGenerated = false, isAI = false) {
      const previewBox = document.getElementById('behaviorPreview');
      const copyBtn = document.getElementById('copyPreviewBtn');
      const complianceStatus = document.getElementById('complianceStatus');
      
      if (!text || text.trim() === '') {
        updatePreview(); // ê¸°ë³¸ ë¯¸ë¦¬ë³´ê¸°ë¡œ ëŒì•„ê°€ê¸°
        return;
      }
      
      // AI ìƒì„± í…ìŠ¤íŠ¸ í‘œì‹œ
      previewBox.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© í´ë¦¬ì–´
      
      // ìƒì„± ë°©ì‹ í‘œì‹œ ë°°ì§€ ì¶”ê°€
      const badge = document.createElement('div');
      badge.className = `generation-badge ${isAI ? 'ai-badge' : 'basic-badge'}`;
      badge.innerHTML = isAI ? 
        'ğŸ¤– AI ì „ë¬¸ ìƒì„±' : 
        'ğŸ“ ê¸°ë³¸ ìƒì„±';
      
      // í…ìŠ¤íŠ¸ ë‚´ìš© ì¶”ê°€
      const textContent = document.createElement('div');
      textContent.className = 'preview-text';
      textContent.textContent = text;
      
      // ë³µì‚¬ ë²„íŠ¼ ì¶”ê°€ (í•­ìƒ í‘œì‹œ)
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button visible';
      copyButton.innerHTML = 'ğŸ“‹ ë³µì‚¬';
      copyButton.onclick = () => copyToClipboard('behaviorPreview');
      
      // ìš”ì†Œë“¤ì„ ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ì— ì¶”ê°€
      previewBox.appendChild(badge);
      previewBox.appendChild(textContent);
      previewBox.appendChild(copyButton);
      
      // ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš©
      previewBox.classList.remove('has-content', 'ai-generated', 'basic-generated');
      previewBox.classList.add('has-content');
      if (isAI) {
        previewBox.classList.add('ai-generated');
      } else if (isGenerated) {
        previewBox.classList.add('basic-generated');
      }
      
      // ê·œì • ì¤€ìˆ˜ ê²€ì‚¬ í‘œì‹œ
      checkCompliance(text);
      complianceStatus.classList.remove('hidden');
      
      // ê¸°ì¡´ ë³µì‚¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ìƒˆ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´ë¨)
      const oldCopyBtn = document.getElementById('copyPreviewBtn');
      if (oldCopyBtn) {
        oldCopyBtn.classList.add('hidden');
      }
    }

    // í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ìƒì„±
    // ê¸°ì¡´ í•¨ìˆ˜ ì œê±°ë¨ - AI í†µí•© í•¨ìˆ˜ë¡œ êµì²´

    // í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ì €ì¥
    function saveBehaviorText() {
      if (!behaviorText) {
        showAlert('ë¨¼ì € í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      // Google Sheets ì €ì¥ êµ¬í˜„
      showAlert('Google Sheets ì €ì¥ ê¸°ëŠ¥ì€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
    }

    // ëˆ„ê°€ê¸°ë¡ ìƒì„±
    function generateRecords() {
      if (!behaviorText) {
        showAlert('ë¨¼ì € í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      const count = parseInt(document.getElementById('recordCount').value);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            generatedRecords = result.records;
            displayRecords(result.records);
            showAlert(`${result.totalCount}ê°œì˜ ëˆ„ê°€ê¸°ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          } else {
            showAlert(result.message, 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ëˆ„ê°€ê¸°ë¡ ìƒì„± ì‹¤íŒ¨:', error);
          showAlert('ëˆ„ê°€ê¸°ë¡ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'warning');
        })
        .generateCumulativeRecords(behaviorText, count);
    }

    // ëˆ„ê°€ê¸°ë¡ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
    function displayRecords(records) {
      const container = document.getElementById('recordsList');
      const copyAllBtn = document.getElementById('copyAllRecordsBtn');
      
      if (!records || records.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 12px; margin: 1rem 0;">
            <p style="color: #666; margin-bottom: 1rem; font-size: 1rem;">ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            
            <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
              <h4 style="color: #856404; margin: 0 0 0.5rem 0; font-size: 1rem;">âš ï¸ ë‹¤ì¤‘ í•™ìƒ ìƒì„± ì‹œ ì°¸ê³ ì‚¬í•­</h4>
              <p style="color: #856404; margin: 0; font-size: 0.9rem; line-height: 1.4;">
                ì—¬ëŸ¬ í•™ìƒì„ í•œ ë²ˆì— ìƒì„±í•  ë•Œ Rate Limitingìœ¼ë¡œ ì¸í•´ ì¼ë¶€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                <strong>ê¶Œì¥:</strong> 1-2ëª…ì”© ë‚˜ëˆ„ì–´ ìƒì„±í•˜ê±°ë‚˜, ì‹¤íŒ¨ ì‹œ ê°œë³„ í•™ìƒìœ¼ë¡œ ì¬ì‹œë„í•´ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>
        `;
        copyAllBtn.style.display = 'none';
        return;
      }
      
      // ì „ì²´ ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
      copyAllBtn.style.display = 'inline-block';
      
      container.innerHTML = records.map((record, index) => `
        <div class="preview-box fade-in" style="margin-bottom: 1rem; position: relative;" data-record-index="${index}">
          <div class="record-header">
            <strong>ëˆ„ê°€ê¸°ë¡ ${index + 1}ë²ˆ</strong>
            <button class="copy-button-small" onclick="copyIndividualRecord(${index})" title="ì´ ê¸°ë¡ë§Œ ë³µì‚¬">
              ğŸ“‹
            </button>
          </div>
          <div class="record-content" id="record-${index}">
            ${record.text}
          </div>
          <div class="record-meta">
            ğŸ“… ${record.date} | ğŸ“ ${record.length}ì ${record.generated === 'ai' ? '| ğŸ¤– AI ìƒì„±' : ''}
          </div>
        </div>
      `).join('');
      
      // ì „ì—­ ë³€ìˆ˜ì— ê¸°ë¡ ì €ì¥ (ë³µì‚¬ìš©)
      window.currentRecords = records;
    }
    
    // ê°œë³„ ëˆ„ê°€ê¸°ë¡ ë³µì‚¬
    function copyIndividualRecord(index) {
      if (!window.currentRecords || !window.currentRecords[index]) {
        showAlert('ë³µì‚¬í•  ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      const record = window.currentRecords[index];
      copyToClipboard('record-' + index, record.text);
    }
    
    // ì „ì²´ ëˆ„ê°€ê¸°ë¡ ë³µì‚¬
    function copyAllRecords() {
      if (!window.currentRecords || window.currentRecords.length === 0) {
        showAlert('ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      const allRecordsText = window.currentRecords.map((record, index) => 
        `[ëˆ„ê°€ê¸°ë¡ ${index + 1}] (${record.date})\n${record.text}\n`
      ).join('\n');
      
      navigator.clipboard.writeText(allRecordsText).then(() => {
        showAlert(`ì „ì²´ ëˆ„ê°€ê¸°ë¡ ${window.currentRecords.length}ê°œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
      }).catch(err => {
        showAlert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      });
    }

    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„±
    function createWorkspace() {
      const userName = prompt('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
      if (!userName) return;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            currentSpreadsheetId = result.spreadsheetId;
            showAlert(`ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! 
              <a href="${result.spreadsheetUrl}" target="_blank">Google Sheets ì—´ê¸°</a>`, 'success');
          } else {
            showAlert(result.message, 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨:', error);
          showAlert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'warning');
        })
        .createUserWorkspace(userName);
    }

    // ì„ íƒ ì´ˆê¸°í™”
    function clearSelection() {
      selectedKeywords = [];
      document.querySelectorAll('.keyword-checkbox').forEach(cb => cb.checked = false);
      updateSelectedKeywords();
      updateStatistics();
      updatePreview();
      showAlert('ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    // ê°œì„ ëœ ë³µì‚¬ í•¨ìˆ˜ (ì˜¤ë²„ë¡œë“œ ì§€ì›)
    function copyToClipboard(elementIdOrText, customText = null) {
      let text;
      
      if (customText) {
        // ì»¤ìŠ¤í…€ í…ìŠ¤íŠ¸ê°€ ì œê³µëœ ê²½ìš°
        text = customText;
      } else if (typeof elementIdOrText === 'string' && document.getElementById(elementIdOrText)) {
        // ìš”ì†Œ IDê°€ ì œê³µëœ ê²½ìš°
        const element = document.getElementById(elementIdOrText);
        text = element.value || element.textContent || element.innerText;
      } else {
        // ì§ì ‘ í…ìŠ¤íŠ¸ê°€ ì œê³µëœ ê²½ìš°
        text = elementIdOrText;
      }
      
      if (!text || text.trim() === '') {
        showAlert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      copyText(text);
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(function() {
        showAlert('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      }).catch(function(error) {
        console.error('ë³µì‚¬ ì‹¤íŒ¨:', error);
        // í´ë°±: textareaë¥¼ ì´ìš©í•œ ë³µì‚¬ ì‹œë„
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showAlert('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } catch (fallbackError) {
          showAlert('âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      });
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = message;
      
      document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // ğŸ”„ í–¥ìƒëœ ë¡œë”© ì¸ë””ì¼€ì´í„° í•¨ìˆ˜ë“¤
    function showLoadingOverlay(message = 'ì²˜ë¦¬ ì¤‘...', subMessage = '') {
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'loadingOverlay';
      loadingOverlay.className = 'loading-overlay';
      loadingOverlay.innerHTML = `
        <div>
          <div class="loading-spinner"></div>
          <div style="text-align: center;">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">${message}</div>
            ${subMessage ? `<div style="font-size: 0.9rem; color: #666;">${subMessage}</div>` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    }

    function hideLoadingOverlay() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) {
        loadingOverlay.remove();
      }
    }

    function showLoadingProgress(message = 'ìƒì„± ì¤‘...', progressMessage = '') {
      const progressDiv = document.createElement('div');
      progressDiv.id = 'loadingProgress';
      progressDiv.className = 'loading-progress';
      progressDiv.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 0.5rem;">${message}</div>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        <div style="font-size: 0.9rem; color: #666;">${progressMessage}</div>
      `;
      
      // ê¸°ì¡´ progressê°€ ìˆìœ¼ë©´ ì œê±°
      const existingProgress = document.getElementById('loadingProgress');
      if (existingProgress) {
        existingProgress.remove();
      }
      
      // ì ì ˆí•œ ìœ„ì¹˜ì— ì¶”ê°€ (í˜„ì¬ í™œì„± íƒ­ ë˜ëŠ” container ìƒë‹¨)
      const container = document.querySelector('.container');
      container.insertBefore(progressDiv, container.firstChild);
      
      return progressDiv;
    }

    function hideLoadingProgress() {
      const progressDiv = document.getElementById('loadingProgress');
      if (progressDiv) {
        progressDiv.remove();
      }
    }

    function updateLoadingProgress(message, subMessage = '') {
      const progressDiv = document.getElementById('loadingProgress');
      if (progressDiv) {
        progressDiv.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 0.5rem;">${message}</div>
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <div style="font-size: 0.9rem; color: #666;">${subMessage}</div>
        `;
      }
    }

    // ê¸°íƒ€ í•¨ìˆ˜ë“¤
    function saveRecords() {
      showAlert('ëˆ„ê°€ê¸°ë¡ ì €ì¥ ê¸°ëŠ¥ì€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'info');
    }

    function exportRecords() {
      showAlert('Excel ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function openSampleWorkspace() {
      showAlert('ìƒ˜í”Œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function addStudent() {
      showAlert('í•™ìƒ ì¶”ê°€ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function saveStudentData() {
      showAlert('í•™ìƒ ì •ë³´ ì €ì¥ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }
    
    function generateRecords() {
      const recordCount = parseInt(document.getElementById('recordCount')?.value || 5);
      const includeActivities = document.getElementById('includeActivities')?.checked || false;
      const behaviorText = document.getElementById('behaviorTextInput')?.value?.trim() || '';
      
      if (!behaviorText) {
        showAlert('ëˆ„ê°€ê¸°ë¡ ìƒì„±ì„ ìœ„í•´ì„œëŠ” ë¨¼ì € í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      if (selectedKeywords.length === 0) {
        showAlert('ëˆ„ê°€ê¸°ë¡ ìƒì„±ì„ ìœ„í•´ì„œëŠ” í‚¤ì›Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      // ê¸°ë³¸ ëˆ„ê°€ê¸°ë¡ í…œí”Œë¦¿ ìƒì„±
      const records = [];
      const today = new Date();
      
      for (let i = 0; i < recordCount; i++) {
        const recordDate = new Date(today);
        recordDate.setDate(today.getDate() - (recordCount - 1 - i) * 3); // 3ì¼ ê°„ê²©
        
        const dateStr = recordDate.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).replace(/\. /g, '.').replace(/\.$/, '');
        
        // ì„ íƒëœ í‚¤ì›Œë“œì—ì„œ ëœë¤í•˜ê²Œ ì„ íƒí•˜ì—¬ ê¸°ë¡ ìƒì„±
        const randomKeywords = selectedKeywords.sort(() => 0.5 - Math.random()).slice(0, 2);
        const keywordTexts = randomKeywords.map(sk => {
          const category = keywordDatabase.find(cat => cat.id === sk.categoryId);
          const keyword = category?.keywords.find(k => k.id === sk.keywordId);
          return keyword?.autoText || keyword?.text || sk.text;
        });
        
        const recordContent = `${keywordTexts.join(', ')} ëª¨ìŠµì„ ë³´ì„.`;
        
        records.push({
          date: dateStr,
          content: recordContent
        });
      }
      
      displaySingleStudentRecords(records);
      showAlert(`${recordCount}ê°œì˜ ëˆ„ê°€ê¸°ë¡ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    }
    
    function displaySingleStudentRecords(records) {
      const container = document.getElementById('generatedRecords');
      if (!container) return;
      
      let html = '<div class="records-list">';
      records.forEach((record, index) => {
        html += `
          <div class="record-item" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin: 0.5rem 0;">
            <div class="record-header" style="font-weight: 600; color: #495057; margin-bottom: 0.5rem;">
              ${record.date}
            </div>
            <div class="record-content" style="color: #333; line-height: 1.5;">
              ${record.content}
            </div>
          </div>`;
      });
      html += '</div>';
      
      container.innerHTML = html;
      
      // ë³µì‚¬ ë²„íŠ¼ í‘œì‹œ
      const copyBtn = document.getElementById('copyRecordsBtn');
      if (copyBtn) {
        copyBtn.style.display = 'inline-block';
      }
    }
    
    // í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ë³µì‚¬
    function copyBehaviorText() {
      const behaviorTextInput = document.getElementById('behaviorTextInput');
      if (behaviorTextInput && behaviorTextInput.value.trim()) {
        copyToClipboard(behaviorTextInput.value.trim());
      } else {
        showAlert('ë³µì‚¬í•  í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      }
    }
    
    // í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ ì§€ìš°ê¸°
    function clearBehaviorText() {
      const behaviorTextInput = document.getElementById('behaviorTextInput');
      if (behaviorTextInput) {
        behaviorTextInput.value = '';
        showAlert('í–‰ë™íŠ¹ì„± í…ìŠ¤íŠ¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'info');
      }
    }
    
    // ëª¨ë“  ëˆ„ê°€ê¸°ë¡ ë³µì‚¬ (ë‚ ì§œ ì œì™¸)
    function copyAllRecords() {
      const recordsContainer = document.getElementById('generatedRecords');
      if (!recordsContainer) {
        showAlert('ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      const recordItems = recordsContainer.querySelectorAll('.record-item');
      if (recordItems.length === 0) {
        showAlert('ë³µì‚¬í•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
      }
      
      let allRecordsText = '';
      recordItems.forEach((item, index) => {
        const contentElement = item.querySelector('.record-content');
        if (contentElement) {
          // ë‚ ì§œ ì •ë³´ëŠ” ì œì™¸í•˜ê³  ë‚´ìš©ë§Œ ì¶”ì¶œ
          let content = contentElement.textContent || contentElement.innerText;
          // ë‚ ì§œ íŒ¨í„´ ì œê±° (YYYY.MM.DD í˜•ì‹)
          content = content.replace(/\d{4}\.\d{2}\.\d{2}\.?\s*/g, '').trim();
          allRecordsText += `${index + 1}. ${content}\n\n`;
        }
      });
      
      if (allRecordsText.trim()) {
        copyToClipboard(allRecordsText.trim());
      } else {
        showAlert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      }
    }

    // ==================== AI ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤ ====================
    
    // API í‚¤ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
    function toggleApiKeyVisibility() {
      const apiKeyInput = document.getElementById('geminiApiKey');
      const toggleBtn = document.getElementById('toggleApiKey');
      
      if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        toggleBtn.textContent = 'ğŸ™ˆ ìˆ¨ê¸°ê¸°';
      } else {
        apiKeyInput.type = 'password';
        toggleBtn.textContent = 'ğŸ‘ï¸ ë³´ê¸°';
      }
    }

    // ì¤‘ë³µëœ async testApiKey í•¨ìˆ˜ ì œê±°ë¨ - ì•„ë˜ì— ê°œì„ ëœ ë²„ì „ ì‚¬ìš©

    // API í‚¤ ì €ì¥
    function saveApiKey() {
      const apiKey = document.getElementById('geminiApiKey').value.trim();
      
      if (!apiKey) {
        showAlert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      try {
        // Google Apps Script Propertiesì— ì €ì¥
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              geminiApiKey = apiKey;
              // localStorageì—ë„ ì €ì¥
              localStorage.setItem('geminiApiKey', apiKey);
              updateApiStatus('connected', 'API í‚¤ê°€ ì €ì¥ë˜ê³  í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
              showAlert('API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
              loadAiSettings(); // ì„¤ì • ìƒˆë¡œê³ ì¹¨
            } else {
              showAlert('API í‚¤ ì €ì¥ ì‹¤íŒ¨: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showAlert('API í‚¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
          })
          .setApiKey(apiKey);
      } catch (error) {
        showAlert('API í‚¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // API í‚¤ í…ŒìŠ¤íŠ¸
    function testApiKey() {
      const apiKey = document.getElementById('geminiApiKey').value.trim();
      
      console.log('ğŸ§ª API í‚¤ í…ŒìŠ¤íŠ¸ ì‹œì‘, í‚¤ ê¸¸ì´:', apiKey.length);
      
      if (!apiKey) {
        showAlert('ë¨¼ì € API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      if (apiKey.length < 20) {
        showAlert('API í‚¤ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      const testBtn = document.querySelector('button[onclick="testApiKey()"]');
      if (testBtn) {
        testBtn.disabled = true;
        testBtn.innerHTML = 'â³ í…ŒìŠ¤íŠ¸ ì¤‘...';
      }
      
      updateApiStatus('testing', 'API í‚¤ ìœ íš¨ì„±ì„ í™•ì¸í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
      
      try {
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
            
            if (testBtn) {
              testBtn.disabled = false;
              testBtn.innerHTML = 'ğŸ§ª API í‚¤ í…ŒìŠ¤íŠ¸';
            }
            
            if (result && result.success) {
              geminiApiKey = apiKey;
              // localStorageì—ë„ ì €ì¥
              localStorage.setItem('geminiApiKey', apiKey);
              updateApiStatus('connected', `API í‚¤ í…ŒìŠ¤íŠ¸ ì„±ê³µ! (${result.keyPreview || ''}) AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
              
              const successMsg = result.testResponse ? 
                `ğŸ‰ API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!\ní…ŒìŠ¤íŠ¸ ì‘ë‹µ: "${result.testResponse}"` :
                'ğŸ‰ API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!';
                
              showAlert(successMsg, 'success');
              
              // ìë™ìœ¼ë¡œ ì €ì¥ ì œì•ˆ
              setTimeout(() => {
                if (confirm('í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ì´ API í‚¤ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                  saveApiKey();
                }
              }, 1000);
              
            } else {
              updateApiStatus('error', 'API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
              
              let errorMsg = 'âŒ API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨';
              if (result && result.message) {
                errorMsg += `: ${result.message}`;
              }
              if (result && result.error) {
                errorMsg += ` (${result.error})`;
              }
              
              showAlert(errorMsg, 'error');
              
              // ì˜¤ë¥˜ ìœ í˜•ë³„ ê°€ì´ë“œ ì œê³µ
              if (result && result.error === 'INVALID_API_KEY') {
                setTimeout(() => {
                  showAlert('ğŸ“ íŒ: Google AI Studioì—ì„œ API í‚¤ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'info');
                }, 2000);
              }
            }
          })
          .withFailureHandler(function(error) {
            console.error('ğŸ§ª í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
            
            if (testBtn) {
              testBtn.disabled = false;
              testBtn.innerHTML = 'ğŸ§ª API í‚¤ í…ŒìŠ¤íŠ¸';
            }
            
            updateApiStatus('error', 'API í‚¤ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜');
            showAlert(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
          })
          .testGeminiApiKey(apiKey);
      } catch (error) {
        if (testBtn) {
          testBtn.disabled = false;
          testBtn.textContent = 'ğŸ§ª API í…ŒìŠ¤íŠ¸';
        }
        showAlert('API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // API í‚¤ ì œê±°
    function clearApiKey() {
      if (!confirm('ì •ë§ë¡œ API í‚¤ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì œê±° í›„ì—ëŠ” AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
      }

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            geminiApiKey = '';
            // localStorageì—ì„œë„ ì œê±°
            localStorage.removeItem('geminiApiKey');
            document.getElementById('geminiApiKey').value = '';
            updateApiStatus('', 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            showAlert('API í‚¤ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
          })
          .withFailureHandler(function(error) {
            showAlert('API í‚¤ ì œê±° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
          })
          .clearApiKey();
      } catch (error) {
        showAlert('API í‚¤ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // API ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateApiStatus(status, message) {
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      
      // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
      statusIndicator.className = 'status-indicator';
      
      // ìƒˆ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
      if (status) {
        statusIndicator.classList.add(status);
      }
      
      statusText.textContent = message;
    }

    // AI ì„¤ì • ë¡œë“œ
    function loadAiSettings() {
      try {
        google.script.run
          .withSuccessHandler(function(settings) {
            if (settings) {
              // AI ì„¤ì • í¼ì— ê°’ ì„¤ì •
              document.getElementById('behaviorStyle').value = settings.behaviorStyle || 'standard';
              document.getElementById('recordCount').value = settings.recordCount || 5;
              document.getElementById('includeActivities').checked = settings.includeActivities !== false;
              document.getElementById('useAiFallback').checked = settings.useAiFallback !== false;
              
              // API í‚¤ ìƒíƒœ í™•ì¸
              if (settings.hasApiKey) {
                updateApiStatus('connected', 'API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
                // API í‚¤ í”Œë˜ê·¸ë§Œ ì„¤ì • (ì‹¤ì œ í‚¤ëŠ” ë°±ì—”ë“œì—ì„œ ê´€ë¦¬)
                geminiApiKey = 'API_KEY_AVAILABLE';
              } else {
                updateApiStatus('', 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                geminiApiKey = '';
              }
              
              // ì‚¬ìš©ëŸ‰ í†µê³„ ì—…ë°ì´íŠ¸
              updateUsageStats(settings.usage || {});
            }
          })
          .withFailureHandler(function(error) {
            console.warn('AI ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            updateApiStatus('', 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          })
          .getAiSettings();
      } catch (error) {
        console.warn('AI ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
      }
    }

    // ì‚¬ìš©ëŸ‰ í†µê³„ ì—…ë°ì´íŠ¸
    function updateUsageStats(usage) {
      document.getElementById('todayUsage').textContent = usage.today || 0;
      document.getElementById('monthUsage').textContent = usage.month || 0;
      document.getElementById('totalUsage').textContent = usage.total || 0;
      
      usageStats = usage;
    }

    // AI ì„¤ì • ì €ì¥
    function saveAiSettings() {
      const settings = {
        behaviorStyle: document.getElementById('behaviorStyle').value,
        recordCount: parseInt(document.getElementById('recordCount').value),
        includeActivities: document.getElementById('includeActivities').checked,
        useAiFallback: document.getElementById('useAiFallback').checked
      };

      try {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              aiSettings = settings;
              showAlert('AI ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
              showAlert('AI ì„¤ì • ì €ì¥ ì‹¤íŒ¨: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showAlert('AI ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
          })
          .saveAiSettings(settings);
      } catch (error) {
        showAlert('AI ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // AI ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    function isAiEnabled() {
      return geminiApiKey && geminiApiKey !== '';
    }

    // ìƒì„± í•¨ìˆ˜ë“¤ì„ AI ê¸°ëŠ¥ê³¼ ì—°ë™í•˜ë„ë¡ ìˆ˜ì •
    function generateBehaviorText() {
      console.log('generateBehaviorText í•¨ìˆ˜ í˜¸ì¶œë¨');
      console.log('ì„ íƒëœ í‚¤ì›Œë“œ ìˆ˜:', selectedKeywords.length);
      console.log('API í‚¤ ìƒíƒœ:', geminiApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •');
      
      if (selectedKeywords.length === 0) {
        showAlert('í‚¤ì›Œë“œë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      // API í‚¤ ë¯¸ì„¤ì • ì‹œ ëª…í™•í•œ ì•ˆë‚´
      if (!geminiApiKey || geminiApiKey === '') {
        showAlert('ğŸ’¡ íŒ: AI ì„¤ì • íƒ­ì—ì„œ GEMINI API í‚¤ë¥¼ ë“±ë¡í•˜ë©´ ë” ì „ë¬¸ì ì¸ í–‰ë™íŠ¹ì„±ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì§€ê¸ˆì€ ê¸°ë³¸ ìƒì„±ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'info');
      }

      const generateBtn = document.getElementById('generateBtn');
      if (!generateBtn) {
        console.error('generateBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }
      
      generateBtn.disabled = true;
      generateBtn.innerHTML = 'â³ ìƒì„± ì¤‘...';

      // ğŸ”„ í–¥ìƒëœ ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      showLoadingProgress(
        `âœ¨ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬ ìƒì„± ì¤‘...`,
        `ì„ íƒëœ í‚¤ì›Œë“œ ${selectedKeywords.length}ê°œë¥¼ ë°”íƒ•ìœ¼ë¡œ í–‰ë™íŠ¹ì„±ì„ ìƒì„±í•©ë‹ˆë‹¤.`
      );

      // ğŸ”¥ ê°œì„ ëœ API í‚¤ ì „ì†¡ ë¡œì§
      if (geminiApiKey && geminiApiKey.trim() !== '') {
        console.log('ğŸ”‘ API í‚¤ ì „ì†¡ ì‹œë„:', geminiApiKey.slice(-4));
        
        google.script.run
          .withSuccessHandler(function(keyResult) {
            console.log('ğŸ”‘ API í‚¤ ì„¤ì • ê²°ê³¼:', keyResult);
            
            if (keyResult && keyResult.success) {
              console.log('âœ… API í‚¤ ì„¤ì • ì„±ê³µ - AI ìƒì„± ëª¨ë“œë¡œ ì§„í–‰');
              proceedWithGeneration();
            } else {
              console.warn('âš ï¸ API í‚¤ ì„¤ì • ì‹¤íŒ¨ - ê¸°ë³¸ ìƒì„±ìœ¼ë¡œ ì§„í–‰');
              showAlert(`API í‚¤ ì˜¤ë¥˜: ${keyResult?.message || 'ì•Œ ìˆ˜ ì—†ìŒ'}. ê¸°ë³¸ ìƒì„±ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.`, 'warning');
              proceedWithGeneration();
            }
          })
          .withFailureHandler(function(error) {
            console.error('ğŸ”‘ API í‚¤ ì „ì†¡ ì‹¤íŒ¨:', error);
            showAlert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ê¸°ë³¸ ìƒì„±ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.', 'warning');
            proceedWithGeneration();
          })
          .setApiKey(geminiApiKey.trim());
      } else {
        console.log('ğŸ”‘ API í‚¤ ì—†ìŒ - ê¸°ë³¸ ìƒì„±ìœ¼ë¡œ ì§ì ‘ ì§„í–‰');
        updateLoadingProgress('âœ¨ í–‰ë™íŠ¹ì„± ìƒì„± ì¤‘...', 'API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì €ì¥ëœ í‚¤ ë˜ëŠ” ê¸°ë³¸ ìƒì„±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
        proceedWithGeneration();
      }

      // ì‹¤ì œ ìƒì„± ë¡œì§
      function proceedWithGeneration() {
        console.log('ğŸ”¥ proceedWithGeneration í•¨ìˆ˜ ì‹œì‘');
        console.log('ğŸ”¥ ì„ íƒëœ í‚¤ì›Œë“œ ìˆ˜:', selectedKeywords.length);
        console.log('ğŸ”¥ í˜„ì¬ ê¸€ììˆ˜ ì„¤ì •:', currentCharCount);
        console.log('ğŸ”¥ í˜„ì¬ ì»¨í…ì¸  ìŠ¤íƒ€ì¼:', currentContentStyle);
        
        // ë§¥ë½ ì •ë³´ ìˆ˜ì§‘
        const context = {
          observationContext: document.getElementById('observationContext')?.value || '',
          classActivity: document.getElementById('classActivity')?.value || '',
          specialProgram: document.getElementById('specialProgram')?.value || '',
          charCount: currentCharCount,
          contentStyle: currentContentStyle
        };
        
        console.log('ğŸ”¥ ì „ì†¡í•  context:', context);

        try {
          console.log('ğŸ”¥ Google Apps Script í˜¸ì¶œ ì‹œì‘');
          google.script.run
            .withSuccessHandler(function(result) {
            console.log('ğŸ”¥ Code.gs ì‘ë‹µ:', result);
            
            // ğŸ”„ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
            hideLoadingProgress();
            
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'âœ¨ í–‰ë™íŠ¹ì„± ìƒì„±';
            
            if (result && result.success) {
              behaviorText = result.text;
              
              // behaviorTextInput ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
              const behaviorTextInput = document.getElementById('behaviorTextInput');
              if (behaviorTextInput) {
                behaviorTextInput.value = result.text;
              }
              
              if (typeof updateComplianceIndicators === 'function') {
                updateComplianceIndicators(result.compliance);
              }
              
              // ğŸ”¥ í•µì‹¬: ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì´ì œ textarea ì‚¬ìš©)
              const mainTextarea = document.getElementById('behaviorPreview');
              if (mainTextarea) {
                mainTextarea.value = result.text;
                updatePreviewFromTextarea();
              }
              
              if (typeof updateBehaviorPreview === 'function') {
                updateBehaviorPreview(result.text, true, result.generated === 'ai');
              }
              
              // ğŸ’¾ í•™ìƒë³„ í–‰ë™íŠ¹ì„± ë°ì´í„° ì €ì¥
              const currentStudent = getCurrentStudentInfo();
              if (currentStudent) {
                const saved = saveStudentBehaviorData(
                  currentStudent,
                  result.text,
                  result.compliance,
                  selectedKeywords.map(k => k.text)
                );
                
                if (saved) {
                  console.log(`âœ… ${currentStudent.name} í•™ìƒ ë°ì´í„° ì €ì¥ ì™„ë£Œ`);
                  showAlert(`ğŸ“š ${currentStudent.name} í•™ìƒì˜ í–‰ë™íŠ¹ì„±ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                  
                  // ë‹¤ìŒ í•™ìƒì„ ìœ„í•´ í•™ìƒ ì •ë³´ ì´ˆê¸°í™”
                  setTimeout(() => {
                    document.getElementById('studentNumber').value = '';
                    document.getElementById('studentName').value = '';
                    updateStudentInfo();
                  }, 1000);
                }
              }
              
              // ğŸ¯ ìë™ íƒ­ ì „í™˜ ì œê±° - ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì´ë™í•˜ë„ë¡ ë³€ê²½
              setTimeout(() => {
                console.log('ğŸ“ í–‰ë™íŠ¹ì„± ìƒì„± ì™„ë£Œ - ìë™ íƒ­ ì „í™˜ ì—†ì´ ìœ ì§€');
                // ìë™ íƒ­ ì „í™˜ ë¹„í™œì„±í™” - ì‚¬ìš©ìê°€ ì—¬ëŸ¬ í•™ìƒ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ í•¨
                // if (typeof switchTab === 'function') {
                //   switchTab('records');
                // }
                if (typeof updateBehaviorTabContent === 'function') {
                  console.log('ğŸ“ í–‰ë™íŠ¹ì„± ë‚´ìš© ì—…ë°ì´íŠ¸ ì¤‘...');
                  updateBehaviorTabContent(result.text, result.generated === 'ai', result.compliance);
                } else {
                  console.error('âŒ updateBehaviorTabContent í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
              }, 500);
              
              // AI ìƒì„± ì—¬ë¶€ í‘œì‹œ
              if (result.generated === 'ai') {
                showAlert('ğŸ¤– AIë¡œ ìƒì„±ëœ ì „ë¬¸ í–‰ë™íŠ¹ì„±ì…ë‹ˆë‹¤! ëˆ„ê°€ê¸°ë¡ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'success');
                updateUsageStats({ 
                  today: usageStats.today + 1, 
                  month: usageStats.month + 1, 
                  total: usageStats.total + 1 
                });
              } else {
                console.log('ğŸ”¥ ê¸°ë³¸ ìƒì„±ëœ ì´ìœ :', result.fallbackReason || 'ì•Œ ìˆ˜ ì—†ìŒ');
                showAlert('ğŸ“ ê¸°ë³¸ ë°©ì‹ìœ¼ë¡œ ìƒì„±ëœ í–‰ë™íŠ¹ì„±ì…ë‹ˆë‹¤. (AI ìƒì„± ì‹¤íŒ¨: ' + (result.fallbackReason || 'ì•Œ ìˆ˜ ì—†ìŒ') + ')', 'info');
              }
            } else {
              console.error('ğŸ”¥ ì‘ë‹µ ê²°ê³¼ê°€ ë¹„ì •ìƒ:', result);
              showAlert('í–‰ë™íŠ¹ì„± ìƒì„± ì‹¤íŒ¨: ' + (result?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ğŸ”¥ Google Apps Script í˜¸ì¶œ ì‹¤íŒ¨:', error);
            
            // ğŸ”„ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
            hideLoadingProgress();
            
            generateBtn.disabled = false;
            generateBtn.innerHTML = 'âœ¨ í–‰ë™íŠ¹ì„± ìƒì„±';
            showAlert('ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
          })
          .generateBehaviorCharacteristics(selectedKeywords, context);
        } catch (error) {
          console.error('ğŸ”¥ proceedWithGeneration ì˜ˆì™¸:', error);
          
          // ğŸ”„ ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
          hideLoadingProgress();
          
          generateBtn.disabled = false;
          generateBtn.innerHTML = 'âœ¨ í–‰ë™íŠ¹ì„± ìƒì„±';
          showAlert('í–‰ë™íŠ¹ì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } // proceedWithGeneration í•¨ìˆ˜ ë‹«ê¸°
    } // generateBehaviorText í•¨ìˆ˜ ë‹«ê¸°

    // ìˆ˜ë™ í¸ì§‘ì„ ìœ„í•œ ìƒˆë¡œìš´ í•¨ìˆ˜ë“¤
    function updatePreviewFromTextarea() {
      const textarea = document.getElementById('behaviorPreview');
      const charCountDisplay = document.getElementById('charCountDisplay');
      
      if (textarea && charCountDisplay) {
        const currentLength = textarea.value.length;
        charCountDisplay.textContent = `${currentLength}ì`;
        
        // ê¸€ììˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
        if (currentLength > 500) {
          charCountDisplay.style.color = '#dc3545';
          charCountDisplay.textContent += ' (ì´ˆê³¼)';
        } else if (currentLength > 450) {
          charCountDisplay.style.color = '#fd7e14';
        } else {
          charCountDisplay.style.color = '#28a745';
        }
        
        // ì‹¤ì‹œê°„ NEIS ê·œì • ê²€ì‚¬
        if (currentLength > 0) {
          updateComplianceCheck(textarea.value);
        }
      }
    }
    
    function clearBehaviorText() {
      const textarea = document.getElementById('behaviorPreview');
      if (textarea) {
        textarea.value = '';
        updatePreviewFromTextarea();
        textarea.focus();
      }
    }
    
    function formatBehaviorText() {
      const textarea = document.getElementById('behaviorPreview');
      if (textarea && textarea.value.trim()) {
        let text = textarea.value.trim();
        
        // ê¸°ë³¸ ì •ë¦¬
        text = text.replace(/\s+/g, ' '); // ì—°ì† ê³µë°± ì œê±°
        text = text.replace(/\. +/g, '. '); // ë§ˆì¹¨í‘œ í›„ ê³µë°± ì •ë¦¬
        
        // ë§ˆì§€ë§‰ì— ë§ˆì¹¨í‘œê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (!text.endsWith('.')) {
          text += '.';
        }
        
        textarea.value = text;
        updatePreviewFromTextarea();
        
        // ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°±
        showAlert('í…ìŠ¤íŠ¸ê°€ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    }
    
    function updateComplianceCheck(text) {
      // NEIS ê·œì • ê²€ì‚¬ ë¡œì§
      if (!text || text.length === 0) {
        // ë¹ˆ í…ìŠ¤íŠ¸ì¼ ë•Œ ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹
        const emptyCompliance = {
          lengthOk: false,
          endingOk: false,
          contentOk: true,
          length: 0
        };
        if (typeof updateComplianceIndicators === 'function') {
          updateComplianceIndicators(emptyCompliance);
        }
        return;
      }
      
      const compliance = {
        lengthOk: text.length <= 500 && text.length >= 50,
        endingOk: /(í•¨|ì„|ë¨|ìŒ|ì„ ë³´ì„|ë¥¼ ë³´ì„|ì— í•´ë‹¹í•¨|ìœ¼ë¡œ ë‚˜íƒ€ë‚¨|í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„|ë¼ê³  í•  ìˆ˜ ìˆìŒ)$/.test(text.trim()),
        contentOk: !(/\d{4}ë…„|\d{1,2}ì›”|\d{1,2}ì¼|\d{1,2}ì‹œ|\d{1,2}ë¶„|ê¹€\w+|ì´\w+|ë°•\w+|ìµœ\w+|ì •\w+|ì˜¤ëŠ˜|ì–´ì œ|ë‚´ì¼/).test(text),
        length: text.length
      };
      
      // ê·œì • ì¤€ìˆ˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
      if (typeof updateComplianceIndicators === 'function') {
        updateComplianceIndicators(compliance);
      }
      
      // ë©”ì¸ íƒ­ì˜ ê·œì • ê²€ì‚¬ ì˜ì—­ë„ ì—…ë°ì´íŠ¸
      updateMainTabCompliance(compliance);
    }
    
    function updateMainTabCompliance(compliance) {
      const complianceStatus = document.getElementById('complianceStatus');
      if (!complianceStatus) return;
      
      // ê·œì • ê²€ì‚¬ ì˜ì—­ í‘œì‹œ
      complianceStatus.classList.remove('hidden');
      
      // ê° í•­ëª© ì—…ë°ì´íŠ¸
      const lengthIcon = document.getElementById('lengthIcon');
      const lengthCheck = document.getElementById('lengthCheck');
      const endingIcon = document.getElementById('endingIcon');
      const endingCheck = document.getElementById('endingCheck');
      const contentIcon = document.getElementById('contentIcon');
      const contentCheck = document.getElementById('contentCheck');
      
      if (lengthIcon && lengthCheck) {
        lengthIcon.textContent = compliance.lengthOk ? 'âœ…' : 'âŒ';
        lengthCheck.textContent = `ê¸€ì ìˆ˜: ${compliance.length || 0}/500ì ${compliance.lengthOk ? '(ì í•©)' : '(ë¶€ì í•©)'}`;
        lengthCheck.style.color = compliance.lengthOk ? '#28a745' : '#dc3545';
      }
      
      if (endingIcon && endingCheck) {
        endingIcon.textContent = compliance.endingOk ? 'âœ…' : 'âŒ';
        endingCheck.textContent = `ëª…ì‚¬í˜• ì¢…ê²° ${compliance.endingOk ? '(ì í•©)' : '(ë¶€ì í•©)'}`;
        endingCheck.style.color = compliance.endingOk ? '#28a745' : '#dc3545';
      }
      
      if (contentIcon && contentCheck) {
        contentIcon.textContent = compliance.contentOk ? 'âœ…' : 'âŒ';
        contentCheck.textContent = `ê¸ˆì§€ ë‚´ìš© ${compliance.contentOk ? 'ì—†ìŒ (ì í•©)' : 'í¬í•¨ë¨ (ë¶€ì í•©)'}`;
        contentCheck.style.color = compliance.contentOk ? '#28a745' : '#dc3545';
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ˆê¸° ê¸€ììˆ˜ í‘œì‹œ
      updatePreviewFromTextarea();
      
      // textarea ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const textarea = document.getElementById('behaviorPreview');
      if (textarea) {
        // ì‹¤ì‹œê°„ ê¸€ììˆ˜ ë° ê·œì • ê²€ì‚¬
        textarea.addEventListener('input', updatePreviewFromTextarea);
        
        // í˜ì´ìŠ¤íŠ¸ ì´ë²¤íŠ¸ë„ ì²˜ë¦¬
        textarea.addEventListener('paste', function(e) {
          setTimeout(updatePreviewFromTextarea, 100);
        });
      }
    });

    // ì¤‘ë³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨ - ìœ„ì—ì„œ í†µí•©ë¨

    // ğŸ”’ ë³´ì•ˆ ê°•í™”: ì…ë ¥ê°’ ê²€ì¦ ë° XSS ë°©ì§€
    function validateInput(input, maxLength = 30) {
      if (typeof input !== 'string') return '';
      // HTML íƒœê·¸, ìŠ¤í¬ë¦½íŠ¸, íŠ¹ìˆ˜ë¬¸ì ì œê±°
      return input.trim()
                  .replace(/[<>"`']/g, '')
                  .replace(/javascript:/gi, '')
                  .replace(/on\w+=/gi, '')
                  .substring(0, maxLength);
    }
    
    // DOM ì•ˆì „ ìƒì„± í•¨ìˆ˜
    function createSafeElement(tag, className = '', textContent = '') {
      const element = document.createElement(tag);
      if (className) element.className = className;
      if (textContent) element.textContent = validateInput(textContent, 1000);
      return element;
    }

    // ğŸ”¥ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ëˆ„ê°€ê¸°ë¡ ìƒì„± (ë°±ì—”ë“œ ìš°íšŒ)
    async function generateCumulativeRecordsDirectly(studentsData, recordCount, dateSettings) {
      console.log('ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ ìƒì„± ì‹œì‘');
      console.log('ğŸ“ í•™ìƒ ë°ì´í„°:', studentsData);
      console.log('ğŸ“ ê°œìˆ˜:', recordCount);
      console.log('ğŸ“… ë‚ ì§œ ì„¤ì •:', dateSettings);
      
      try {
        // API í‚¤ í™•ì¸
        const apiKey = await getCurrentApiKey();
        if (!apiKey) {
          throw new Error('ì‹¤ì œ GEMINI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. AI ì„¤ì • íƒ­ì—ì„œ AIzaë¡œ ì‹œì‘í•˜ëŠ” API í‚¤ë¥¼ ì…ë ¥í•˜ê³  í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”.');
        }
        
        const results = [];
        const year = dateSettings?.year || 2025;
        const startMonth = dateSettings?.startMonth || 3;
        const endMonth = dateSettings?.endMonth || 7;
        
        // ê° í•™ìƒë³„ë¡œ ëˆ„ê°€ê¸°ë¡ ìƒì„± (ê°•í™”ëœ Rate Limiting ëŒ€ì‘)
        for (let i = 0; i < studentsData.length; i++) {
          const student = studentsData[i];
          console.log(`ğŸ“š ${student.name} í•™ìƒ ì²˜ë¦¬ ì¤‘... (${i + 1}/${studentsData.length})`);
          
          // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
          const progressPercent = Math.round(((i) / studentsData.length) * 100);
          const generateBtn = document.querySelector('button[onclick="generateStudentRecords()"]');
          if (generateBtn) {
            generateBtn.innerHTML = `â³ ìƒì„± ì¤‘... ${student.name} (${i + 1}/${studentsData.length}) - ${progressPercent}%`;
          }
          
          const studentRecords = [];
          
          // í•™ìƒë³„ ì²˜ë¦¬ ì‹œì‘ ì „ ëŒ€ê¸° (Rate Limit ì™„í™”)
          if (i > 0) {
            console.log(`â³ í•™ìƒ ${i + 1} ì²˜ë¦¬ ì „ 3ì´ˆ ëŒ€ê¸°...`);
            await new Promise(resolve => setTimeout(resolve, 3000));
          }
          
          // ê°œë³„ ëˆ„ê°€ê¸°ë¡ ìƒì„±
          for (let j = 0; j < recordCount; j++) {
            console.log(`ğŸ“ ${student.name} - ëˆ„ê°€ê¸°ë¡ ${j + 1}/${recordCount} ìƒì„± ì¤‘`);
            
            try {
              // GEMINI API í˜¸ì¶œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
              const prompt = createCumulativeRecordPrompt(student.behaviorText, 1);
              
              // ğŸ”„ ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ API í˜¸ì¶œ (ìµœëŒ€ 5íšŒ ì‹œë„)
              const response = await callGeminiApiWithRetry(apiKey, prompt, 5);
              
              if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
              }
              
              const data = await response.json();
              console.log('ğŸ¯ GEMINI API ì‘ë‹µ:', data);
              
              if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                throw new Error('API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              }
              
              let generatedText = data.candidates[0].content.parts[0].text;
              
              // JSON í˜•íƒœì¸ ê²½ìš° íŒŒì‹± ì‹œë„
              if (generatedText.includes('{') && generatedText.includes('}')) {
                try {
                  const parsed = JSON.parse(generatedText);
                  if (parsed.record) {
                    generatedText = parsed.record;
                  } else if (Array.isArray(parsed) && parsed[0] && parsed[0].record) {
                    generatedText = parsed[0].record;
                  }
                } catch (parseError) {
                  // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œ
                  const match = generatedText.match(/"record":\s*"([^"]+)"/);
                  if (match && match[1]) {
                    generatedText = match[1];
                  }
                }
              }
              
              // í…ìŠ¤íŠ¸ ì •ë¦¬
              generatedText = generatedText
                .replace(/^["']|["']$/g, '')
                .replace(/\\n/g, ' ')
                .replace(/\\"/g, '"')
                .trim();
              
              // NEIS ê·œì • ì¤€ìˆ˜ í™•ì¸
              if (!checkRecordCompliance(generatedText)) {
                generatedText = ensureRecordCompliance(generatedText);
              }
              
              // ëœë¤ ë‚ ì§œ ìƒì„±
              const randomDate = generateRandomSchoolDate(year, startMonth, endMonth);
              const formattedDate = formatDate(randomDate);
              
              studentRecords.push({
                text: generatedText,
                date: formattedDate,
                rawDate: randomDate
              });
              
              console.log(`âœ… ${student.name} - ëˆ„ê°€ê¸°ë¡ ${j + 1} ìƒì„± ì™„ë£Œ`);
              
              // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ ê°•í™” (Rate Limit ëŒ€ì‘)
              console.log(`â³ ë‹¤ìŒ API í˜¸ì¶œê¹Œì§€ 5ì´ˆ ëŒ€ê¸°...`);
              await new Promise(resolve => setTimeout(resolve, 5000));
              
            } catch (recordError) {
              console.error(`âŒ ${student.name} - ëˆ„ê°€ê¸°ë¡ ${j + 1} ìƒì„± ì‹¤íŒ¨:`, recordError);
              
              // Rate Limit ì˜¤ë¥˜ì¸ ê²½ìš° ë” ê¸´ ëŒ€ê¸°
              if (recordError.message && recordError.message.includes('429')) {
                console.log(`â³ Rate Limit ì˜¤ë¥˜ - ì¶”ê°€ 15ì´ˆ ëŒ€ê¸°...`);
                await new Promise(resolve => setTimeout(resolve, 15000));
              }
              
              // í´ë°± ëˆ„ê°€ê¸°ë¡ ìƒì„±
              const fallbackText = `${student.name} í•™ìƒì˜ ëˆ„ê°€ê¸°ë¡ ${j + 1} (ìƒì„± ì˜¤ë¥˜)`;
              const randomDate = generateRandomSchoolDate(year, startMonth, endMonth);
              const formattedDate = formatDate(randomDate);
              
              studentRecords.push({
                text: fallbackText,
                date: formattedDate,
                rawDate: randomDate
              });
            }
          }
          
          results.push({
            studentNumber: student.number,
            studentName: student.name,
            records: studentRecords,
            behaviorText: student.behaviorText,
            keywords: student.keywords || []
          });
        }
        
        console.log('ğŸ‰ ëª¨ë“  í•™ìƒ ëˆ„ê°€ê¸°ë¡ ìƒì„± ì™„ë£Œ:', results);
        
        return {
          success: true,
          records: results,
          totalStudents: studentsData.length,
          recordsPerStudent: recordCount,
          totalRecords: results.reduce((sum, student) => sum + student.records.length, 0)
        };
        
      } catch (error) {
        console.error('âŒ í”„ë¡ íŠ¸ì—”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
        
        return {
          success: false,
          error: error.message,
          message: 'ëˆ„ê°€ê¸°ë¡ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message,
          records: [],
          totalStudents: studentsData?.length || 0,
          recordsPerStudent: recordCount || 5,
          totalRecords: 0
        };
      }
    }
    
    // ëˆ„ê°€ê¸°ë¡ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„± (ì—´ë¦° í˜•íƒœë¡œ ê°œì„ )
    function createCumulativeRecordPrompt(behaviorText, count) {
      // ë‹¤ì–‘ì„±ì„ ìœ„í•œ ëœë¤ ë³€ìˆ˜ ìƒì„±
      const diversityElements = [
        "í•™ìŠµ íƒœë„ì™€ ì°¸ì—¬ ëª¨ìŠµ",
        "ë™ë£Œì™€ì˜ í˜‘ë ¥ ê´€ê³„",
        "ë¬¸ì œ í•´ê²° ì ‘ê·¼ ë°©ì‹",
        "í•™ìŠµ ê³¼ì •ì—ì„œì˜ íŠ¹ì„±",
        "ê³¼ì œ ìˆ˜í–‰ ì‹œì˜ ëª¨ìŠµ",
        "í‘œí˜„ ë° ì†Œí†µ ëŠ¥ë ¥",
        "í•™ìŠµì— ëŒ€í•œ ê´€ì‹¬ê³¼ ë…¸ë ¥"
      ];
      
      const randomElement = diversityElements[Math.floor(Math.random() * diversityElements.length)];
      const timestamp = Date.now(); // ìœ ë‹ˆí¬í•œ ìš”ì†Œ ì¶”ê°€
      
      return `ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì´ˆë“±í•™êµ êµì‚¬ë¥¼ ë•ëŠ” AI ì¡°ìˆ˜ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ 'í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬'ì„ ë°”íƒ•ìœ¼ë¡œ, í•™ìƒì˜ ${randomElement}ì„ ì¤‘ì‹¬ìœ¼ë¡œ ${count}ê°œì˜ **ì™„ì „íˆ ë‹¤ë¥¸** ëˆ„ê°€ê¸°ë¡ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ¯ ì—´ë¦° í˜•íƒœ ëˆ„ê°€ê¸°ë¡ ì‘ì„± ì§€ì¹¨ (ë§¤ìš° ì¤‘ìš”!)
1. **ì¼ë°˜ì  í‘œí˜„**: ëª¨ë“  í•™ìƒì—ê²Œ ì ìš© ê°€ëŠ¥í•œ ì¼ë°˜ì ì¸ í‘œí˜„ ì‚¬ìš©
2. **êµ¬ì²´ì  ìƒí™© ê¸ˆì§€**: "ì°°í™ìœ¼ë¡œ", "ì˜¤ë‹µë…¸íŠ¸ë¥¼", "ì¹œêµ¬ì˜ ì‘í’ˆì´ ë¬´ë„ˆì ¸ì„œ" ë“± êµ¬ì²´ì  ìƒí™© ì„œìˆ  ê¸ˆì§€
3. **ì¶”ìƒì  í–‰ë™**: "í˜‘ë ¥í•˜ì—¬", "ë…¸ë ¥í•˜ë©°", "ì§‘ì¤‘í•˜ì—¬" ë“± ì¶”ìƒì ì´ê³  ì¼ë°˜ì ì¸ í–‰ë™ ì¤‘ì‹¬
4. **ë³´í¸ì  ë§¥ë½**: ì–´ë–¤ í•™ê¸‰, ì–´ë–¤ ìƒí™©ì—ì„œë„ í™œìš© ê°€ëŠ¥í•œ ë‚´ìš©
5. **íŠ¹ì • ë„êµ¬/ìƒí™© ë°°ì œ**: íŠ¹ì • êµêµ¬, êµ¬ì²´ì  ì‚¬ê±´, ê³ ìœ í•œ ìƒí™© ì–¸ê¸‰ ê¸ˆì§€

### ğŸš« ë‚´ìš© ì¤‘ë³µ ë°©ì§€ ì›ì¹™ (ì ˆëŒ€ ì¤‘ìš”!)
1. **ì™„ì „í•œ ì°¨ë³„í™”**: ê° ëˆ„ê°€ê¸°ë¡ì€ ì™„ì „íˆ ë‹¤ë¥¸ ê´€ì°° ê´€ì ì—ì„œ ì‘ì„±
2. **ìœ ì‚¬ í‘œí˜„ ê¸ˆì§€**: ë¹„ìŠ·í•œ ë™ì‚¬, í˜•ìš©ì‚¬, ë¬¸ì¥ êµ¬ì¡° ì‚¬ìš© ê¸ˆì§€
3. **ë‹¤ì–‘í•œ ì˜ì—­ í™œìš©**: í•™ìŠµíƒœë„, í˜‘ë ¥ê´€ê³„, ë¬¸ì œí•´ê²°, í‘œí˜„ëŠ¥ë ¥, ì°¸ì—¬ë„ ë“± ë‹¤ë¥¸ ì˜ì—­ ì¤‘ì‹¬
4. **ë¶€ë¶„ ì¤‘ë³µ ë°°ì œ**: ë¬¸ì¥ì˜ ì¼ë¶€ë¶„ì´ë¼ë„ ìœ ì‚¬í•œ ë‚´ìš© í¬í•¨ ê¸ˆì§€
5. **ë…ì°½ì  ì„œìˆ **: ê°ê°ì˜ ê¸°ë¡ì´ ë…ë¦½ì ì´ê³  ë…ì°½ì ì¸ ê´€ì°° ë‚´ìš©ì´ì–´ì•¼ í•¨

### ğŸ¨ ë‹¤ì–‘ì„± í™•ë³´ ì „ëµ
- **1ë²ˆì§¸ ê¸°ë¡**: í•™ìŠµ ì°¸ì—¬ íƒœë„ ì¤‘ì‹¬
- **2ë²ˆì§¸ ê¸°ë¡**: ë™ë£Œ ê´€ê³„ ë° í˜‘ë ¥ ì¤‘ì‹¬  
- **3ë²ˆì§¸ ê¸°ë¡**: ë¬¸ì œ í•´ê²° ë°©ì‹ ì¤‘ì‹¬
- **4ë²ˆì§¸ ê¸°ë¡**: í‘œí˜„ ë° ì†Œí†µ ëŠ¥ë ¥ ì¤‘ì‹¬
- **5ë²ˆì§¸ ê¸°ë¡**: í•™ìŠµ ê´€ë¦¬ ë° ì„±ì°° ì¤‘ì‹¬

### ğŸš« í”¼í•´ì•¼ í•  êµ¬ì²´ì  í‘œí˜„ ì˜ˆì‹œ
- "ì°°í™ìœ¼ë¡œ ì¸ë¬¼ìƒì„ ë§Œë“¤ ë•Œ" â†’ "ì°½ì‘ í™œë™ ì‹œ"
- "ì¹œêµ¬ì˜ ì‘í’ˆì´ ë¬´ë„ˆì§€ì" â†’ "ì–´ë ¤ì›€ì— ì§ë©´í•œ ì¹œêµ¬ë¥¼ ë„ìš°ë©°"
- "ì˜¤ë‹µë…¸íŠ¸ë¥¼ ê¼¼ê¼¼í•˜ê²Œ ì‘ì„±í•˜ê³ " â†’ "í•™ìŠµ ë‚´ìš©ì„ ì •ë¦¬í•˜ê³ "
- "ì¸í„°ë„· ê²€ìƒ‰ì„ í†µí•´" â†’ "ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ"

### âœ… ê¶Œì¥í•˜ëŠ” ì¼ë°˜ì  í‘œí˜„ ì˜ˆì‹œ (ê°ê° ë‹¤ë¥¸ ì˜ì—­)
- "í•™ìŠµ í™œë™ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©°" (ì°¸ì—¬ë„)
- "ë™ë£Œì™€ í˜‘ë ¥í•˜ì—¬ ê³¼ì œë¥¼ ìˆ˜í–‰í•˜ê³ " (í˜‘ë ¥ê´€ê³„)
- "ì–´ë ¤ìš´ ë¬¸ì œì— ëˆê¸° ìˆê²Œ ë„ì „í•˜ë©°" (ë¬¸ì œí•´ê²°)
- "ìì‹ ì˜ ìƒê°ì„ ëª…í™•í•˜ê²Œ í‘œí˜„í•˜ê³ " (í‘œí˜„ëŠ¥ë ¥)
- "í•™ìŠµ ê³¼ì •ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë©°" (í•™ìŠµê´€ë¦¬)

### â˜…â˜…â˜…â˜…â˜… ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì¶œë ¥ ê·œì¹™ â˜…â˜…â˜…â˜…â˜…
1. **ì£¼ì–´ ìƒëµ:** ê´€ì°° ê¸°ë¡ì²˜ëŸ¼ ì£¼ì–´('í•œ í•™ìƒì€', 'ìì‹ ì´' ë“±)ë¥¼ ì™„ì „íˆ ìƒëµí•˜ê³ , ë°”ë¡œ í–‰ë™ ì„œìˆ ë¡œ ì‹œì‘í•´ì•¼ í•¨
2. **ë‚ ì§œ/ì‹œê°„ ê¸ˆì§€:** ëˆ„ê°€ê¸°ë¡ ë‚´ìš©ì— '3ì›” 15ì¼', '1êµì‹œ'ì™€ ê°™ì€ êµ¬ì²´ì ì¸ ë‚ ì§œë‚˜ ì‹œê°„ì„ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ
3. **ë§ˆì¹¨í‘œ í•„ìˆ˜:** ëª¨ë“  ë¬¸ì¥ì˜ ëì— ë°˜ë“œì‹œ ë§ˆì¹¨í‘œ(.)ë¥¼ ì°ì–´ì•¼ í•¨
4. **ëª…ì‚¬í˜• ì¢…ê²° + ë§ˆì¹¨í‘œ:** '~í•¨.', '~ìŒ.', '~ì„ ë³´ì„.' í˜•íƒœë¡œ ì¢…ê²°
5. **ì¼ë°˜ì„± ìœ ì§€:** ì–´ë–¤ í•™ìƒì—ê²Œë„ ì ìš© ê°€ëŠ¥í•œ ì¼ë°˜ì ì¸ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±
6. **ì™„ì „ ì°¨ë³„í™”:** ê° ê¸°ë¡ì€ ì™„ì „íˆ ë‹¤ë¥¸ ë‚´ìš©ê³¼ í‘œí˜„ìœ¼ë¡œ ì‘ì„±

---
**[í•™ìƒì˜ í–‰ë™íŠ¹ì„± ë° ì¢…í•©ì˜ê²¬]**
${behaviorText}
---

**ìƒì„± ìš”êµ¬ì‚¬í•­ (ì¤‘ìš”!):**
- ${count}ê°œì˜ ëˆ„ê°€ê¸°ë¡ì€ **ì™„ì „íˆ ë‹¤ë¥¸ ë‚´ìš©**ì´ì–´ì•¼ í•©ë‹ˆë‹¤ (ìœ ì‚¬í•œ ë‹¨ì–´, í‘œí˜„, êµ¬ì¡° ì‚¬ìš© ê¸ˆì§€)
- ê° ê¸°ë¡ì€ **ë‹¤ë¥¸ ê´€ì°° ì˜ì—­**ì— ì´ˆì ì„ ë§ì¶° ì‘ì„± (í•™ìŠµíƒœë„/í˜‘ë ¥ê´€ê³„/ë¬¸ì œí•´ê²°/í‘œí˜„ëŠ¥ë ¥/í•™ìŠµê´€ë¦¬ ë“±)
- êµ¬ì²´ì  ìƒí™©ë³´ë‹¤ëŠ” ì¼ë°˜ì ì¸ í•™ìŠµ íƒœë„ì™€ íŠ¹ì„± ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±
- ë°˜ë“œì‹œ ë§ˆì¹¨í‘œ(.)ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤
- ê¸€ì ìˆ˜: 100ì~150ì ë‚´ì™¸ë¡œ ì‘ì„±
- ë°˜ë“œì‹œ ì£¼ì–´ì§„ í–‰ë™íŠ¹ì„±ì„ ê·¼ê±°ë¡œ ì‘ì„±
- ëª¨ë“  í•™ê¸‰ì—ì„œ í™œìš© ê°€ëŠ¥í•œ ì—´ë¦° í˜•íƒœë¡œ ì‘ì„±
- **ì¤‘ë³µ ì²´í¬**: ìƒì„± í›„ ê° ê¸°ë¡ì´ ì„œë¡œ ë‹¤ë¥¸ì§€ ë°˜ë“œì‹œ í™•ì¸
- ìœ ë‹ˆí¬ ID: ${timestamp}

JSON í˜•ì‹ ì˜ˆì‹œ:
[{"record": "í•™ìŠµ í™œë™ì— ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•˜ë©° ë™ë£Œë“¤ê³¼ í˜‘ë ¥í•˜ì—¬ ê³¼ì œë¥¼ ì™„ìˆ˜í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„."}]`;
    }
    
    // í˜„ì¬ API í‚¤ ê°€ì ¸ì˜¤ê¸° (ì „ì—­ ë³€ìˆ˜ì—ì„œ)
    async function getCurrentApiKey() {
      try {
        console.log('ğŸ“± í˜„ì¬ API í‚¤ í™•ì¸ ì¤‘...');
        console.log('ğŸ“± ì „ì—­ geminiApiKey:', geminiApiKey ? 'ì„¤ì •ë¨' : 'ë¯¸ì„¤ì •');
        
        // ì „ì—­ ë³€ìˆ˜ì—ì„œ ë¨¼ì € í™•ì¸ (í”Œë˜ê·¸ ê°’ ì œì™¸)
        if (geminiApiKey && geminiApiKey.length > 10 && geminiApiKey !== 'API_KEY_AVAILABLE' && geminiApiKey.startsWith('AIza')) {
          console.log('âœ… ì „ì—­ ë³€ìˆ˜ì—ì„œ API í‚¤ ë°œê²¬:', geminiApiKey.substring(0, 4) + '...');
          return geminiApiKey;
        }
        
        // localStorageì—ì„œ í™•ì¸ (í”Œë˜ê·¸ ê°’ ì œì™¸)
        const storedKey = localStorage.getItem('geminiApiKey');
        if (storedKey && storedKey.length > 10 && storedKey !== 'API_KEY_AVAILABLE' && storedKey.startsWith('AIza')) {
          console.log('âœ… localStorageì—ì„œ API í‚¤ ë°œê²¬:', storedKey.substring(0, 4) + '...');
          geminiApiKey = storedKey; // ì „ì—­ ë³€ìˆ˜ì—ë„ ì„¤ì •
          return storedKey;
        }
        
        console.log('âŒ ìœ íš¨í•œ API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (í”Œë˜ê·¸ ê°’ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹)');
        console.log('ğŸ’¡ AI ì„¤ì • íƒ­ì—ì„œ ì‹¤ì œ GEMINI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return null;
        
      } catch (error) {
        console.error('API í‚¤ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
        return null;
      }
    }
    
    // ëˆ„ê°€ê¸°ë¡ ê·œì • ì¤€ìˆ˜ í™•ì¸ (100-150ì ê¸°ì¤€)
    function checkRecordCompliance(text) {
      if (!text || typeof text !== 'string') return false;
      
      // ê¸¸ì´ í™•ì¸ (100-150ì)
      if (text.length < 100 || text.length > 150) return false;
      
      // ë§ˆì¹¨í‘œ í™•ì¸
      if (!text.endsWith('.')) return false;
      
      // ëª…ì‚¬í˜• ì¢…ê²° + ë§ˆì¹¨í‘œ í™•ì¸
      if (!/(í•¨\.|ì„\.|ë¨\.|ìŒ\.|ì„ ë³´ì„\.|ë¥¼ ë³´ì„\.|ì— í•´ë‹¹í•¨\.|ìœ¼ë¡œ ë‚˜íƒ€ë‚¨\.|í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„\.|ë¼ê³  í•  ìˆ˜ ìˆìŒ\.)$/.test(text.trim())) return false;
      
      // ê¸ˆì§€ ë‚´ìš© í™•ì¸ (ë‚ ì§œ, ì‹œê°„, êµ¬ì²´ì  ê³ ìœ ëª…ì‚¬)
      if (/\d{4}ë…„|\d{1,2}ì›”|\d{1,2}ì¼|\d{1,2}ì‹œ|\d{1,2}ë¶„|ê¹€\w+|ì´\w+|ë°•\w+|ìµœ\w+|ì •\w+|ì˜¤ëŠ˜|ì–´ì œ|ë‚´ì¼/.test(text)) return false;
      
      return true;
    }
    
    // ëˆ„ê°€ê¸°ë¡ ê·œì • ì¤€ìˆ˜ ë³´ì • (100-150ì ê¸°ì¤€)
    function ensureRecordCompliance(text) {
      if (!text || typeof text !== 'string') return 'í•™ìŠµ í™œë™ì— ì„±ì‹¤íˆ ì°¸ì—¬í•˜ê³  ê¾¸ì¤€íˆ ë…¸ë ¥í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„.';
      
      // ë§ˆì¹¨í‘œ ì¶”ê°€
      if (!text.endsWith('.')) {
        text = text.replace(/[.!?]+$/, '') + '.';
      }
      
      // ê¸¸ì´ ì¡°ì • (100-150ì)
      if (text.length > 150) {
        text = text.substring(0, 147) + '...';
      } else if (text.length < 100) {
        const addText = 'í•˜ë©° ì§€ì†ì ìœ¼ë¡œ ë…¸ë ¥í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„.';
        text = text.replace(/\.$/, '') + addText;
      }
      
      // ëª…ì‚¬í˜• ì¢…ê²° + ë§ˆì¹¨í‘œ ë³´ì •
      if (!/(í•¨\.|ì„\.|ë¨\.|ìŒ\.|ì„ ë³´ì„\.|ë¥¼ ë³´ì„\.|ì— í•´ë‹¹í•¨\.|ìœ¼ë¡œ ë‚˜íƒ€ë‚¨\.|í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„\.|ë¼ê³  í•  ìˆ˜ ìˆìŒ\.)$/.test(text.trim())) {
        text = text.replace(/[.!?]+$/, '') + 'í•˜ëŠ” ëª¨ìŠµì„ ë³´ì„.';
      }
      
      // ê¸ˆì§€ ë‚´ìš© ì œê±°
      text = text.replace(/\d{4}ë…„|\d{1,2}ì›”|\d{1,2}ì¼|\d{1,2}ì‹œ|\d{1,2}ë¶„|ì˜¤ëŠ˜|ì–´ì œ|ë‚´ì¼/g, '');
      text = text.replace(/ê¹€\w+|ì´\w+|ë°•\w+|ìµœ\w+|ì •\w+/g, '');
      
      return text.trim();
    }
    
    // ëœë¤ í•™êµ ë‚ ì§œ ìƒì„±
    function generateRandomSchoolDate(year, startMonth, endMonth) {
      const allWeekdays = [];
      
      for (let month = startMonth; month <= endMonth; month++) {
        const date = new Date(year, month - 1, 1);
        while (date.getMonth() === month - 1) {
          const day = date.getDay();
          if (day > 0 && day < 6) { // ì›”~ê¸ˆ
            allWeekdays.push(new Date(date));
          }
          date.setDate(date.getDate() + 1);
        }
      }
      
      // ëœë¤ ì„ íƒ
      const randomIndex = Math.floor(Math.random() * allWeekdays.length);
      return allWeekdays[randomIndex] || new Date(year, startMonth - 1, 15);
    }
    
    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(date) {
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const weekday = weekdays[date.getDay()];
      
      return `${year}.${month}.${day} (${weekday})`;
    }
    
    // ğŸ”„ ì§€ìˆ˜ ë°±ì˜¤í”„ì™€ ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ GEMINI API í˜¸ì¶œ
    async function callGeminiApiWithRetry(apiKey, prompt, maxRetries = 3) {
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          console.log(`ğŸ”„ API í˜¸ì¶œ ì‹œë„ ${attempt}/${maxRetries}`);
          
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              contents: [{
                parts: [{
                  text: prompt
                }]
              }],
              generationConfig: {
                temperature: 0.7,
                topK: 40,
                topP: 0.95,
                maxOutputTokens: 1000,
              }
            })
          });
          
          // ì„±ê³µì ì¸ ì‘ë‹µ
          if (response.ok) {
            console.log(`âœ… API í˜¸ì¶œ ì„±ê³µ (ì‹œë„ ${attempt})`);
            return response;
          }
          
          // 429 ì˜¤ë¥˜ (Rate Limit) ì²˜ë¦¬ - ë” ê¸´ ëŒ€ê¸° ì‹œê°„
          if (response.status === 429) {
            if (attempt < maxRetries) {
              // ê°•í™”ëœ ì§€ìˆ˜ ë°±ì˜¤í”„: 2^attempt * 10ì´ˆ + ë” ê¸´ ëœë¤ ì§€ì—°
              const baseDelay = Math.pow(2, attempt) * 10000; // 10ì´ˆ ê¸°ë³¸
              const jitterDelay = Math.random() * 5000; // 0-5ì´ˆ ëœë¤
              const totalDelay = baseDelay + jitterDelay;
              
              console.warn(`âš ï¸ Rate limit ì˜¤ë¥˜ (429), ${(totalDelay/1000).toFixed(1)}ì´ˆ í›„ ì¬ì‹œë„...`);
              await new Promise(resolve => setTimeout(resolve, totalDelay));
              continue;
            }
          }
          
          // 503 ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€ ì˜¤ë¥˜ ì²˜ë¦¬
          if (response.status === 503) {
            if (attempt < maxRetries) {
              const serviceDelay = Math.pow(2, attempt) * 5000; // 5ì´ˆ ê¸°ë³¸
              console.warn(`âš ï¸ ì„œë¹„ìŠ¤ ì‚¬ìš© ë¶ˆê°€ ì˜¤ë¥˜ (503), ${(serviceDelay/1000).toFixed(1)}ì´ˆ í›„ ì¬ì‹œë„...`);
              await new Promise(resolve => setTimeout(resolve, serviceDelay));
              continue;
            }
          }
          
          // ê¸°íƒ€ 4xx, 5xx ì˜¤ë¥˜
          if (response.status >= 400) {
            throw new Error(`API ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
          }
          
        } catch (error) {
          console.error(`âŒ API í˜¸ì¶œ ì‹œë„ ${attempt} ì‹¤íŒ¨:`, error);
          
          if (attempt === maxRetries) {
            throw error;
          }
          
          // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ì— ëŒ€í•œ ì¬ì‹œë„ ì§€ì—°
          const retryDelay = 1000 * attempt;
          console.log(`ğŸ”„ ${retryDelay}ms í›„ ì¬ì‹œë„...`);
          await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
      }
      
      throw new Error(`${maxRetries}ë²ˆì˜ ì‹œë„ í›„ì—ë„ API í˜¸ì¶œ ì‹¤íŒ¨`);
    }
    
  </script>
  
  <!-- í‘¸í„° ì˜ì—­ -->
  <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
    <div style="margin-bottom: 1rem;">
      <h3 style="color: white; margin-bottom: 0.5rem; font-size: 1.4rem;">ğŸ“ ëˆ„ê°€ê¸°ë¡ ìƒì„±ê¸° Complete System</h3>
      <p style="color: #E8EAF6; font-size: 1.1rem; margin: 0;">êµìœ¡í˜„ì¥ì˜ íš¨ìœ¨ì„±ì„ ë†’ì´ëŠ” AI ê¸°ë°˜ ëˆ„ê°€ê¸°ë¡ ìë™ ìƒì„± ë„êµ¬</p>
    </div>
    
    <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 1.5rem; margin-top: 1.5rem;">
      <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 2rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.2rem;">ğŸ‘¤</span>
          <span style="font-weight: 600;">ê°œë°œì: ê¹€ë¬¸ì •(ë°•ë‹¬ì´ˆ)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="font-size: 1.2rem;">ğŸ“º</span>
          <span>ìœ íŠœë¸Œ: </span>
          <a href="https://www.youtube.com/@%EB%B0%B0%EC%9B%80%EC%9D%98%EB%8B%AC%EC%9D%B8-p5v" target="_blank" style="color: #FFE082; text-decoration: none; font-weight: 600; border-bottom: 1px solid #FFE082; transition: all 0.3s ease;" onmouseover="this.style.color='#FFF59D'" onmouseout="this.style.color='#FFE082'">ë°°ì›€ì˜ë‹¬ì¸</a>
        </div>
      </div>
      
      <div style="margin-top: 1rem; font-size: 0.9rem; color: #E8EAF6; opacity: 0.8;">
        <p style="margin: 0;">Â© 2025 ê¹€ë¬¸ì •. êµìœ¡ìš©ìœ¼ë¡œ ììœ ë¡­ê²Œ ì‚¬ìš©í•˜ì„¸ìš”. ë¬¸ì˜ëŠ” ìœ íŠœë¸Œ ì±„ë„ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
      </div>
    </div>
  </div>

</body>
</html>